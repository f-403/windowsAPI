# Windows Registry API 使用文档

本文档包含了常用 Windows 注册表相关函数的功能说明、参数说明、示例代码和输出示例。适合系统开发和红队工具研发中对注册表操作的场景。

## 目录

* [RegOpenKeyEx](#RegOpenKeyEx) - 打开已有注册表键
* [RegEnumKeyEx](#RegEnumKeyEx) - 枚举子项
* [RegCreateKeyEx](#RegCreateKeyEx) - 创建或打开注册表键
* [RegEnumValue](#RegEnumValue) - 枚举键值名
* [RegSetValueEx](#RegSetValueEx) - 设置键值数据
* [RegQueryValueEx](#RegQueryValueEx) - 读取键值数据
* [RegDeleteValue](#RegDeleteValue) - 删除键值
* [RegDeleteKeyEx](#RegDeleteKeyEx) - 删除子项

---

### RegOpenKeyEx

打开已有注册键以便读/写/列表操作。

```cpp
LONG RegOpenKeyEx(
  HKEY    hKey,
  LPCSTR  lpSubKey,
  DWORD   ulOptions,
  REGSAM  samDesired,
  PHKEY   phkResult
);
```

**参数说明**

| 参数           | 说明                        |
| ------------ | ------------------------- |
| `hKey`       | 上级键，如 `HKEY_CURRENT_USER` |
| `lpSubKey`   | 子键路径，如 `Software\\MyApp`  |
| `ulOptions`  | 通常填 0                     |
| `samDesired` | 访问权限，如 `KEY_READ`         |
| `phkResult`  | 返回打开后的键句柄                 |

**示例**

```cpp
HKEY hKey;
if (RegOpenKeyEx(HKEY_CURRENT_USER, "Software\\Microsoft", 0, KEY_READ, &hKey) == ERROR_SUCCESS) {
    std::cout << "打开成功" << std::endl;
    RegCloseKey(hKey);
}
```

[MSDN 文档](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa)

---

### RegEnumKeyEx

枚举指定注册键的所有子项。

```cpp
LONG RegEnumKeyEx(
  HKEY hKey,
  DWORD dwIndex,
  LPSTR lpName,
  LPDWORD lpcchName,
  LPDWORD lpReserved,
  LPSTR lpClass,
  LPDWORD lpcchClass,
  PFILETIME lpftLastWriteTime
);
```

**示例**

```cpp
char name[256];
DWORD nameLen = sizeof(name);
for (DWORD i = 0; RegEnumKeyEx(hKey, i, name, &nameLen, NULL, NULL, NULL, NULL) == ERROR_SUCCESS; i++) {
    std::cout << "子项: " << name << std::endl;
    nameLen = sizeof(name);
}
```

[MSDN 文档](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumkeyexa)

---

### RegCreateKeyEx

创建或打开注册表键（如果存在则直接打开）。

```cpp
LONG RegCreateKeyEx(
  HKEY    hKey,
  LPCSTR  lpSubKey,
  DWORD   Reserved,
  LPSTR   lpClass,
  DWORD   dwOptions,
  REGSAM  samDesired,
  LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  PHKEY   phkResult,
  LPDWORD lpdwDisposition
);
```

**示例**

```cpp
HKEY hKey;
DWORD disp;
RegCreateKeyEx(HKEY_CURRENT_USER, "Software\\MyApp", 0, NULL, 0, KEY_ALL_ACCESS, NULL, &hKey, &disp);
if (disp == REG_CREATED_NEW_KEY)
    std::cout << "新键创建了" << std::endl;
else
    std::cout << "键已存在，已打开" << std::endl;
RegCloseKey(hKey);
```

[MSDN 文档](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexa)

---

### RegEnumValue

列出指定键下所有值名。

```cpp
LONG RegEnumValue(
  HKEY    hKey,
  DWORD   dwIndex,
  LPSTR   lpValueName,
  LPDWORD lpcchValueName,
  LPDWORD lpReserved,
  LPDWORD lpType,
  LPBYTE  lpData,
  LPDWORD lpcbData
);
```

**示例**

```cpp
char valName[256];
DWORD valNameLen = sizeof(valName);
for (DWORD i = 0; RegEnumValue(hKey, i, valName, &valNameLen, NULL, NULL, NULL, NULL) == ERROR_SUCCESS; i++) {
    std::cout << "值: " << valName << std::endl;
    valNameLen = sizeof(valName);
}
```

[MSDN 文档](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regenumvaluea)

---

### RegSetValueEx

设置键下值名对应的数据。

```cpp
LONG RegSetValueEx(
  HKEY    hKey,
  LPCSTR  lpValueName,
  DWORD   Reserved,
  DWORD   dwType,
  const BYTE *lpData,
  DWORD   cbData
);
```

**示例**

```cpp
std::string data = "Hello";
RegSetValueEx(hKey, "TestValue", 0, REG_SZ, (const BYTE*)data.c_str(), (DWORD)data.size() + 1);
```

[MSDN 文档](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa)

---

### RegQueryValueEx

读取指定值名的数据。

```cpp
LONG RegQueryValueEx(
  HKEY    hKey,
  LPCSTR  lpValueName,
  LPDWORD lpReserved,
  LPDWORD lpType,
  LPBYTE  lpData,
  LPDWORD lpcbData
);
```

**示例**

```cpp
char buffer[256];
DWORD type = 0;
DWORD size = sizeof(buffer);
if (RegQueryValueEx(hKey, "TestValue", NULL, &type, (LPBYTE)buffer, &size) == ERROR_SUCCESS) {
    std::cout << "读取值: " << buffer << std::endl;
}
```

[MSDN 文档](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regqueryvalueexa)

---

### RegDeleteValue

删除指定值名。

```cpp
LONG RegDeleteValue(
  HKEY   hKey,
  LPCSTR lpValueName
);
```

**示例**

```cpp
RegDeleteValue(hKey, "TestValue");
```

[MSDN 文档](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regdeletevaluea)

---

### RegDeleteKeyEx

删除指定子项（支持 WOW64 平台）

```cpp
LONG RegDeleteKeyEx(
  HKEY    hKey,
  LPCSTR  lpSubKey,
  REGSAM  samDesired,
  DWORD   Reserved
);
```

**示例**

```cpp
RegDeleteKeyEx(HKEY_CURRENT_USER, "Software\\MyApp", KEY_WOW64_64KEY, 0);
```

[MSDN 文档](https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regdeletekeyexa)
