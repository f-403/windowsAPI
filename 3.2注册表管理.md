# Windows æ³¨å†Œè¡¨ API æ“ä½œæ–‡æ¡£ï¼ˆå«å‡½æ•°è¯´æ˜ã€å‚æ•°è¯¦è§£ä¸ç¤ºä¾‹ï¼‰

## ğŸ“‘ ç›®å½•

1. [RegCreateKeyEx - åˆ›å»ºæˆ–æ‰“å¼€æ³¨å†Œè¡¨é”®](#regcreatekeyex)
2. [RegOpenKeyEx - æ‰“å¼€å·²æœ‰æ³¨å†Œè¡¨é”®](#regopenkeyex)
3. [RegEnumKeyEx - æšä¸¾å­é¡¹](#regenumkeyex)
4. [RegEnumValue - æšä¸¾é”®å€¼å](#regenumvalue)
5. [RegSetValueEx - è®¾ç½®é”®å€¼æ•°æ®](#regsetvalueex)
6. [RegQueryValueEx - è¯»å–é”®å€¼æ•°æ®](#regqueryvalueex)
7. [RegDeleteValue - åˆ é™¤é”®å€¼](#regdeletevalue)
8. [RegDeleteKeyEx - åˆ é™¤å­é¡¹](#regdeletekeyex)
9. [RegCloseKey - å…³é—­æ³¨å†Œè¡¨é”®å¥æŸ„](#regclosekey)
---

## ğŸ“˜ RegCreateKeyEx

**åŠŸèƒ½è¯´æ˜ï¼š** åˆ›å»ºæˆ–æ‰“å¼€æŒ‡å®šçš„æ³¨å†Œè¡¨å­é¡¹ã€‚

**å‡½æ•°åŸå‹ï¼š**

```cpp
LSTATUS RegCreateKeyEx(
  HKEY                  hKey,
  LPCWSTR               lpSubKey,
  DWORD                 Reserved,
  LPWSTR                lpClass,
  DWORD                 dwOptions,
  REGSAM                samDesired,
  LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  PHKEY                 phkResult,
  LPDWORD               lpdwDisposition
);
```

**å‚æ•°è¯´æ˜ï¼ˆç®€åŒ–ï¼‰ï¼š**

- `hKey`ï¼šä¸»é”®ï¼Œå¦‚ `HKEY_CURRENT_USER`
- `lpSubKey`ï¼šè¦åˆ›å»º/æ‰“å¼€çš„å­é”®è·¯å¾„
- `samDesired`ï¼šè®¿é—®æƒé™ï¼Œå¦‚ `KEY_ALL_ACCESS`
- `phkResult`ï¼šè¿”å›é”®å¥æŸ„
- `lpdwDisposition`ï¼šè¿”å›æ˜¯å¦æ–°å»º (`REG_CREATED_NEW_KEY`) æˆ–å·²å­˜åœ¨ (`REG_OPENED_EXISTING_KEY`)

**ç¤ºä¾‹ï¼š**

```cpp
HKEY hKey;
DWORD dw;
LONG ret = RegCreateKeyEx(HKEY_CURRENT_USER, L"Software\NewKey", 0, NULL, 0, KEY_ALL_ACCESS, NULL, &hKey, &dw);
if (ret == ERROR_SUCCESS) {
    wprintf(L"åˆ›å»º/æ‰“å¼€æˆåŠŸ: %s
", dw == REG_CREATED_NEW_KEY ? L"æ–°å»º" : L"å·²å­˜åœ¨");
    RegCloseKey(hKey);
}
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
åˆ›å»º/æ‰“å¼€æˆåŠŸ: æ–°å»º
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regcreatekeyexw)

---

## ğŸ“˜ RegOpenKeyEx

**åŠŸèƒ½è¯´æ˜ï¼š** æ‰“å¼€ä¸€ä¸ªå·²å­˜åœ¨çš„æ³¨å†Œè¡¨é”®ã€‚

**å‡½æ•°åŸå‹ï¼š**

```cpp
LSTATUS RegOpenKeyEx(
  HKEY    hKey,
  LPCWSTR lpSubKey,
  DWORD   ulOptions,
  REGSAM  samDesired,
  PHKEY   phkResult
);
```

**å‚æ•°è¯´æ˜ï¼š**

- `hKey`ï¼šæ ¹é”®ï¼Œå¦‚ `HKEY_CURRENT_USER`
- `lpSubKey`ï¼šè¦æ‰“å¼€çš„å­é”®è·¯å¾„
- `ulOptions`ï¼šä¿ç•™ï¼Œå¿…é¡»ä¸º 0
- `samDesired`ï¼šè®¿é—®æƒé™ï¼ˆå¦‚ `KEY_READ`, `KEY_WRITE`ï¼‰
- `phkResult`ï¼šæˆåŠŸåè¿”å›æ‰“å¼€çš„é”®å¥æŸ„

**ç¤ºä¾‹ï¼š**

```cpp
HKEY hKey;
LONG ret = RegOpenKeyEx(HKEY_CURRENT_USER, L"Software\\TestKey", 0, KEY_READ, &hKey);
if (ret == ERROR_SUCCESS) {
    wprintf(L"æ‰“å¼€æˆåŠŸ\n");
    RegCloseKey(hKey);
} else {
    wprintf(L"æ‰“å¼€å¤±è´¥ï¼Œé”™è¯¯ç ï¼š%ld\n", ret);
}
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
æ‰“å¼€æˆåŠŸ
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regopenkeyexw)

---

## ğŸ“˜ RegEnumKeyEx

**åŠŸèƒ½è¯´æ˜ï¼š** æšä¸¾æŒ‡å®šæ³¨å†Œè¡¨é¡¹çš„å­é¡¹ã€‚

**å‡½æ•°åŸå‹ï¼š**

```cpp
LSTATUS RegEnumKeyEx(
  HKEY      hKey,
  DWORD     dwIndex,
  LPWSTR    lpName,
  LPDWORD   lpcName,
  LPDWORD   lpReserved,
  LPWSTR    lpClass,
  LPDWORD   lpcClass,
  PFILETIME lpftLastWriteTime
);
```

**å‚æ•°è¯´æ˜ï¼š**

- `hKey`ï¼šå·²æ‰“å¼€çš„ä¸»é”®å¥æŸ„
- `dwIndex`ï¼šä» 0 å¼€å§‹çš„ç´¢å¼•
- `lpName`ï¼šæ¥æ”¶å­é”®åçš„ç¼“å†²åŒº
- `lpcName`ï¼š`lpName` ç¼“å†²åŒºå¤§å°
- `lpClass`/`lpcClass`ï¼šå¯ä¸º NULL
- `lpftLastWriteTime`ï¼šå¯ä¸º NULL

**ç¤ºä¾‹ï¼š**

```cpp
DWORD index = 0;
WCHAR subKeyName[256];
DWORD size = 256;
while (RegEnumKeyEx(hKey, index++, subKeyName, &size, NULL, NULL, NULL, NULL) == ERROR_SUCCESS) {
    wprintf(L"å­é¡¹: %s\n", subKeyName);
    size = 256;
}
//ç¬¬ä¸€æ¬¡è°ƒç”¨è·å–é•¿åº¦
DWORD subKeyNameSize = 0;
LONG result = RegEnumKeyExW(
    hKey,           // å·²æ‰“å¼€çš„æ³¨å†Œè¡¨é”®å¥æŸ„
    index,          // å­é”®ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
    NULL,           // ä¸è¯»å–åç§°ï¼Œä»…æŸ¥è¯¢é•¿åº¦
    &subKeyNameSize,// è¿”å›åç§°é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼Œä¸åŒ…æ‹¬\0ï¼‰
    NULL, NULL, NULL, NULL
);
//ç¬¬äºŒæ¬¡è°ƒç”¨ï¼Œ åˆ†é…ç¼“å†²åŒº
std::vector<wchar_t> subKeyName(subKeyNameSize + 1); // +1å­˜æ”¾\0
DWORD bufferSize = subKeyNameSize + 1; // ç¼“å†²åŒºå¤§å°ï¼ˆå«\0ï¼‰
result = RegEnumKeyExW(
    hKey,
    index,
    subKeyName.data(), // å­˜å‚¨å­é”®åç§°
    &bufferSize,      // ä¼ å…¥ç¼“å†²åŒºå¤§å°ï¼ˆå«\0ï¼‰
    NULL, NULL, NULL, NULL
);
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
å­é¡¹: SubKey1
å­é¡¹: SubKey2
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regenumkeyexw)

---



## ğŸ“˜ RegEnumValue

**åŠŸèƒ½è¯´æ˜ï¼š** æšä¸¾æŒ‡å®šæ³¨å†Œè¡¨é¡¹ä¸‹çš„å€¼åå’Œå€¼ç±»å‹ã€‚

**ç¤ºä¾‹ï¼š**

```cpp
DWORD index = 0;
WCHAR valueName[256];
DWORD valueNameSize = 256;
DWORD type;
BYTE data[256];
DWORD dataSize = sizeof(data);
while (RegEnumValue(hKey, index++, valueName, &valueNameSize, NULL, &type, data, &dataSize) == ERROR_SUCCESS) {
    wprintf(L"å€¼å: %s ç±»å‹: %d\n", valueName, type);
    valueNameSize = 256;
    dataSize = sizeof(data);
}
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
å€¼å: Setting ç±»å‹: 1
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regenumvaluew)

---

## ğŸ“˜ RegSetValueEx

**åŠŸèƒ½è¯´æ˜ï¼š** è®¾ç½®æŒ‡å®šåç§°çš„å€¼ã€‚

**ç¤ºä¾‹ï¼š**

```cpp
const wchar_t* data = L"Hello";
RegSetValueEx(hKey, L"MyValue", 0, REG_SZ, (const BYTE*)data, (wcslen(data) + 1) * sizeof(wchar_t));
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
å€¼å·²è®¾ç½®æˆåŠŸ
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regsetvalueexw)

---

## ğŸ“˜ RegQueryValueEx

**åŠŸèƒ½è¯´æ˜ï¼š** æŸ¥è¯¢æŒ‡å®šå€¼çš„å†…å®¹ã€‚

**ç¤ºä¾‹ï¼š**

```cpp
WCHAR buffer[256];
DWORD size = sizeof(buffer);
DWORD type;
RegQueryValueEx(hKey, L"MyValue", NULL, &type, (LPBYTE)buffer, &size);
if (type == REG_SZ) {
    wprintf(L"è¯»å–åˆ°çš„å­—ç¬¦ä¸²: %s\n", buffer);
}

//åŠ¨æ€è·å–å¤§å°
//ç¬¬ä¸€æ¬¡è°ƒç”¨
DWORD valueNameSize = 0;
DWORD dataSize = 0;
LONG result = RegEnumValueW(
    hKey,
    index,
    NULL,          // ä¸è·å–åç§°ï¼ŒåªæŸ¥è¯¢æ‰€éœ€å¤§å°
    &valueNameSize, // è¿”å›åç§°æ‰€éœ€å­—ç¬¦æ•°ï¼ˆä¸åŒ…æ‹¬ç»ˆæ­¢NULLï¼‰
    NULL,
    NULL,
    NULL,         // ä¸è·å–æ•°æ®
    &dataSize     // è¿”å›æ•°æ®æ‰€éœ€å­—èŠ‚æ•°
);
//ç¬¬äºŒæ¬¡è°ƒç”¨
result = RegEnumValueW(
    hKey,
    index,
    valueNameBuffer.data(), // å­˜å‚¨åç§°
    &valueNameSize,         // è¾“å…¥ç¼“å†²åŒºå¤§å°
    NULL,
    &type,                 // æ¥æ”¶æ•°æ®ç±»å‹
    dataBuffer.data(),      // å­˜å‚¨æ•°æ®
    &dataSize              // è¾“å…¥ç¼“å†²åŒºå¤§å°
);
```


**è¾“å‡ºç¤ºä¾‹ï¼š**

```
è¯»å–åˆ°çš„å­—ç¬¦ä¸²: Hello
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regqueryvalueexw)

---

## ğŸ“˜ RegDeleteValue

**åŠŸèƒ½è¯´æ˜ï¼š** åˆ é™¤æŒ‡å®šå€¼åã€‚

**ç¤ºä¾‹ï¼š**

```cpp
RegDeleteValue(hKey, L"MyValue");
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
å€¼åˆ é™¤æˆåŠŸ
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regdeletevaluew)

---

## ğŸ“˜ RegDeleteKeyEx

**åŠŸèƒ½è¯´æ˜ï¼š** åˆ é™¤æ³¨å†Œè¡¨å­é¡¹åŠå…¶å€¼ã€‚
```cpp
å‚æ•°
[in] hKey

æ‰“å¼€çš„æ³¨å†Œè¡¨é¡¹çš„å¥æŸ„ã€‚ æ­¤å¯†é’¥çš„è®¿é—®æƒé™ä¸ä¼šå½±å“åˆ é™¤æ“ä½œã€‚ æœ‰å…³è®¿é—®æƒé™çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… æ³¨å†Œè¡¨é¡¹å®‰å…¨å’Œè®¿é—®æƒé™ã€‚

æ­¤å¥æŸ„ç”± RegCreateKeyEx æˆ– RegOpenKeyEx å‡½æ•°è¿”å›ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»¥ä¸‹ é¢„å®šä¹‰é”®ä¹‹ä¸€ï¼š

HKEY_CLASSES_ROOT
HKEY_CURRENT_CONFIG
HKEY_CURRENT_USER
HKEY_LOCAL_MACHINE
HKEY_USERS
[in] lpSubKey

è¦åˆ é™¤çš„å¯†é’¥çš„åç§°ã€‚ æ­¤é”®å¿…é¡»æ˜¯ç”± hKey å‚æ•°çš„å€¼æŒ‡å®šçš„é”®çš„å­é¡¹ã€‚

è¯¥å‡½æ•°ä½¿ç”¨ DELETE è®¿é—®æƒé™æ‰“å¼€å­é¡¹ã€‚

é”®åç§°ä¸åŒºåˆ†å¤§å°å†™ã€‚

æ­¤å‚æ•°çš„å€¼ä¸èƒ½ NULLã€‚

[in] samDesired

è®¿é—®æ©ç æŒ‡å®šç‰¹å®šäºå¹³å°çš„æ³¨å†Œè¡¨è§†å›¾ã€‚

ä»·å€¼	æ„ä¹‰
KEY_WOW64_32KEY
0x0200
ä» 32 ä½æ³¨å†Œè¡¨è§†å›¾ä¸­åˆ é™¤å¯†é’¥ã€‚
KEY_WOW64_64KEY
0x0100
ä» 64 ä½æ³¨å†Œè¡¨è§†å›¾ä¸­åˆ é™¤å¯†é’¥ã€‚
Reserved

æ­¤å‚æ•°æ˜¯ä¿ç•™çš„ï¼Œå¿…é¡»ä¸ºé›¶ã€‚

è¿”å›å€¼
å¦‚æœå‡½æ•°æˆåŠŸï¼Œåˆ™è¿”å›å€¼ERROR_SUCCESSã€‚

å¦‚æœå‡½æ•°å¤±è´¥ï¼Œåˆ™è¿”å›å€¼ä¸º Winerror.h ä¸­å®šä¹‰çš„éé›¶é”™è¯¯ä»£ç ã€‚ å¯ä»¥å°† FormatMessage å‡½æ•°ä¸FORMAT_MESSAGE_FROM_SYSTEMæ ‡å¿—ä¸€èµ·ä½¿ç”¨ï¼Œä»¥è·å–é”™è¯¯çš„æ³›å‹è¯´æ˜ã€‚
```

**ç¤ºä¾‹ï¼š**

```cpp
RegDeleteKeyEx(HKEY_CURRENT_USER, L"Software\\NewKey", KEY_WOW64_64KEY, 0);
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
å­é”®åˆ é™¤æˆåŠŸ
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regdeletekeyexw)

---

## ğŸ“˜ RegCloseKey

**åŠŸèƒ½è¯´æ˜ï¼š** å…³é—­ä¸€ä¸ªæ³¨å†Œè¡¨é”®å¥æŸ„ã€‚

**å‡½æ•°åŸå‹ï¼š**

```cpp
LSTATUS RegCloseKey(
  HKEY hKey
);
```

**ç¤ºä¾‹ï¼š**

```cpp
RegCloseKey(hKey);
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
å¥æŸ„å…³é—­æˆåŠŸ
```

ğŸ”— [MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/winreg/nf-winreg-regclosekey)

