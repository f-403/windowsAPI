# Windows å †ç®¡ç† API ä¸­æ–‡æ–‡æ¡£

æœ¬æ–‡æ¡£æ•´ç†äº†å¸¸ç”¨çš„ Windows å †ç®¡ç†ç›¸å…³ APIï¼ŒåŒ…æ‹¬å‡½æ•°è¯´æ˜ã€**è¯¦ç»†çš„ä¸­æ–‡å‚æ•°è§£é‡Š**ã€ç¤ºä¾‹ä»£ç ã€è¾“å‡ºè¯´æ˜ä¸å®˜æ–¹ MSDN æ–‡æ¡£é“¾æ¥ã€‚

---

## ç›®å½•ï¼ˆæŒ‰è°ƒç”¨é¡ºåºæ’åˆ—ï¼Œå«åŠŸèƒ½è¯´æ˜ï¼‰

1. [GetSystemInfo](#getsysteminfo) - è·å–ç³»ç»Ÿå†…å­˜é¡µé¢ä¸CPUç­‰ä¿¡æ¯
2. [GetProcessHeap](#getprocessheap) - è·å–é»˜è®¤è¿›ç¨‹å †å¥æŸ„
3. [HeapCreate](#heapcreate) - åˆ›å»ºæ–°çš„ç§æœ‰å †
4. [HeapSetInformation](#heapsetinformation) - è®¾ç½®å †å…¼å®¹æ€§æˆ–è°ƒè¯•ä¿¡æ¯
5. [HeapLock / HeapUnlock](#heaplock--heapunlock) - åŠ é”/è§£é”å †ï¼ˆç”¨äºå¤šçº¿ç¨‹ï¼‰
6. [HeapAlloc](#heapalloc) - ä»å †ä¸­åˆ†é…å†…å­˜
7. [HeapReAlloc](#heaprealloc) - é‡æ–°åˆ†é…å·²åˆ†é…å†…å­˜å—
8. [HeapSize](#heapsize) - è·å–å†…å­˜å—å®é™…å¤§å°
9. [HeapFree](#heapfree) - é‡Šæ”¾å·²åˆ†é…å†…å­˜
10. [HeapCompact](#heapcompact) - å‹ç¼©å †å¹¶è¿”å›å¯ç”¨ç©ºé—´
11. [HeapValidate](#heapvalidate) - éªŒè¯å †çš„å®Œæ•´æ€§æ˜¯å¦æŸå
12. [HeapWalk](#heapwalk) - éå†å †ä¸­æ‰€æœ‰å†…å­˜å—
13. [HeapDestroy](#heapdestroy) - é”€æ¯è‡ªå®šä¹‰å †é‡Šæ”¾èµ„æº

---

## GetSystemInfo

è·å–ç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚é¡µé¢å¤§å°ã€å¤„ç†å™¨æ•°é‡ç­‰ã€‚

```cpp
void GetSystemInfo(LPSYSTEM_INFO lpSystemInfo);
```

**å‚æ•°è¯´æ˜ï¼š**

* `lpSystemInfo`ï¼š$OUT$ æŒ‡å‘ `SYSTEM_INFO` ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºæ¥æ”¶ç³»ç»Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

  * `dwPageSize`ï¼šæ¯é¡µçš„å­—èŠ‚æ•°
  * `dwNumberOfProcessors`ï¼šé€»è¾‘å¤„ç†å™¨æ•°é‡
  * `lpMaximumApplicationAddress`ï¼šè¿›ç¨‹å¯è®¿é—®çš„æœ€é«˜åœ°å€

**ç¤ºä¾‹ï¼š**

```cpp
SYSTEM_INFO si;
GetSystemInfo(&si);
std::cout << "é¡µé¢å¤§å°: " << si.dwPageSize << std::endl;
```

ğŸ“„ MSDNï¼š[GetSystemInfo](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo)

---

## GetProcessHeap

è·å–å½“å‰è¿›ç¨‹çš„é»˜è®¤å †å¥æŸ„ã€‚

```cpp
HANDLE GetProcessHeap();
```

**è¿”å›å€¼ï¼š**

* è¿”å›é»˜è®¤å †çš„å¥æŸ„ï¼Œå¤±è´¥è¿”å› `NULL`ã€‚

**ç¤ºä¾‹ï¼š**

```cpp
HANDLE hHeap = GetProcessHeap();
if (hHeap) std::cout << "é»˜è®¤å †å¥æŸ„: " << hHeap << std::endl;
```

ğŸ“„ MSDNï¼š[GetProcessHeap](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-getprocessheap)

---

## HeapCreate

åˆ›å»ºä¸€ä¸ªæ–°çš„å †å¯¹è±¡ã€‚

```cpp
HANDLE HeapCreate(
  DWORD flOptions,
  SIZE_T dwInitialSize,
  SIZE_T dwMaximumSize
);
```

**å‚æ•°è¯´æ˜ï¼š**

* `flOptions`ï¼š$IN$ å †çš„è¡Œä¸ºé€‰é¡¹ï¼Œå¯å–å€¼ï¼š

  * `HEAP_GENERATE_EXCEPTIONS`ï¼šå†…å­˜åˆ†é…å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
  * `HEAP_NO_SERIALIZE`ï¼šç¦ç”¨çº¿ç¨‹åŒæ­¥ï¼ˆéœ€è‡ªè¡ŒåŠ é”ï¼‰
  * `HEAP_CREATE_ENABLE_EXECUTE`ï¼šå †ä¸­å…è®¸æ‰§è¡Œä»£ç 
* `dwInitialSize`ï¼š$IN$ å †çš„åˆå§‹å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰
* `dwMaximumSize`ï¼š$IN$ å †çš„æœ€å¤§å¤§å°ï¼ˆä¸º 0 è¡¨ç¤ºå¯å¢é•¿ï¼‰

**è¿”å›å€¼ï¼š** æˆåŠŸè¿”å›å †å¥æŸ„ï¼Œå¤±è´¥è¿”å› `NULL`

**ç¤ºä¾‹ï¼š**

```cpp
HANDLE hHeap = HeapCreate(HEAP_CREATE_ENABLE_EXECUTE, 0x1000, 0);
```

ğŸ“„ MSDNï¼š[HeapCreate](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapcreate)

---

## HeapSetInformation

è®¾ç½®å †çš„è¡Œä¸ºä¿¡æ¯ã€‚

```cpp
BOOL HeapSetInformation(
  HANDLE HeapHandle,
  HEAP_INFORMATION_CLASS HeapInformationClass,
  PVOID HeapInformation,
  SIZE_T HeapInformationLength
);
```

**å‚æ•°è¯´æ˜ï¼š**

* `HeapHandle`ï¼šå †å¥æŸ„ï¼ˆå¯ä¸º NULL è¡¨ç¤ºæ‰€æœ‰å †ï¼‰
* `HeapInformationClass`ï¼šæŒ‡å®šè¦è®¾ç½®çš„ä¿¡æ¯ç±»åˆ«ï¼Œå¦‚ `HeapCompatibilityInformation`
* `HeapInformation`ï¼šæŒ‡å‘åŒ…å«è®¾ç½®ä¿¡æ¯çš„ç¼“å†²åŒº
* `HeapInformationLength`ï¼šç¼“å†²åŒºé•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰

ğŸ“„ MSDNï¼š[HeapSetInformation](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapsetinformation)

---

## HeapLock / HeapUnlock

é”å®šæˆ–è§£é”å †ï¼Œé˜²æ­¢å¤šçº¿ç¨‹å†²çªã€‚

```cpp
BOOL HeapLock(HANDLE hHeap);
BOOL HeapUnlock(HANDLE hHeap);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼šå †å¥æŸ„

ğŸ“„ MSDNï¼š

* [HeapLock](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heaplock)
* [HeapUnlock](https://learn.microsoft.com/en-us/windows/win32/api/heapapi-nf-heapapi-heapunlock)

---

## HeapAlloc

ä»å †ä¸­åˆ†é…å†…å­˜ã€‚

```cpp
LPVOID HeapAlloc(HANDLE hHeap, DWORD dwFlags, SIZE_T dwBytes);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼š$IN$ å †å¥æŸ„ï¼ˆå¯ä»¥æ˜¯ `GetProcessHeap()`ï¼‰
* `dwFlags`ï¼š$IN$ æ§åˆ¶åˆ†é…è¡Œä¸ºï¼Œå¦‚ï¼š

  * `HEAP_ZERO_MEMORY`ï¼šå°†å†…å­˜åˆå§‹åŒ–ä¸º 0
* `dwBytes`ï¼š$IN$ è¦åˆ†é…çš„å­—èŠ‚æ•°

**è¿”å›å€¼ï¼š** è¿”å›æŒ‡å‘åˆ†é…å†…å­˜çš„æŒ‡é’ˆï¼Œå¤±è´¥è¿”å› `NULL`

ğŸ“„ MSDNï¼š[HeapAlloc](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc)

---

## HeapReAlloc

é‡æ–°åˆ†é…æŒ‡å®šå†…å­˜å—çš„å¤§å°ã€‚

```cpp
LPVOID HeapReAlloc(HANDLE hHeap, DWORD dwFlags, LPVOID lpMem, SIZE_T dwBytes);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼šå †å¥æŸ„
* `dwFlags`ï¼šå¯ç”¨ `HEAP_ZERO_MEMORY` åˆå§‹åŒ–æ–°å†…å­˜éƒ¨åˆ†
* `lpMem`ï¼šåŸå†…å­˜æŒ‡é’ˆ
* `dwBytes`ï¼šæ–°å†…å­˜å¤§å°

ğŸ“„ MSDNï¼š[HeapReAlloc](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heaprealloc)

---

## HeapSize

è¿”å›æŒ‡å®šå†…å­˜å—çš„å¤§å°ã€‚

```cpp
SIZE_T HeapSize(HANDLE hHeap, DWORD dwFlags, LPCVOID lpMem);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼šå †å¥æŸ„
* `dwFlags`ï¼šä¿ç•™ï¼Œå¿…é¡»ä¸º 0
* `lpMem`ï¼šæŒ‡å‘å†…å­˜çš„æŒ‡é’ˆ

ğŸ“„ MSDNï¼š[HeapSize](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapsize)

---

## HeapFree

é‡Šæ”¾ä½¿ç”¨ `HeapAlloc` åˆ†é…çš„å†…å­˜ã€‚

```cpp
BOOL HeapFree(HANDLE hHeap, DWORD dwFlags, LPVOID lpMem);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼š$IN$ å †å¥æŸ„
* `dwFlags`ï¼šä¿ç•™ï¼Œå¿…é¡»ä¸º 0
* `lpMem`ï¼š$IN$ è¦é‡Šæ”¾çš„å†…å­˜æŒ‡é’ˆ

ğŸ“„ MSDNï¼š[HeapFree](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapfree)

---

## HeapCompact

è¿”å›å·²æäº¤çš„å †ç©ºé—´çš„å¤§å°ã€‚

```cpp
SIZE_T HeapCompact(HANDLE hHeap, DWORD dwFlags);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼šå †å¥æŸ„
* `dwFlags`ï¼šä¿ç•™ï¼Œå¿…é¡»ä¸º 0

ğŸ“„ MSDNï¼š[HeapCompact](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapcompact)

---

## HeapValidate

éªŒè¯å †æ˜¯å¦å·²æŸåã€‚

```cpp
BOOL HeapValidate(HANDLE hHeap, DWORD dwFlags, LPCVOID lpMem);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼šå †å¥æŸ„
* `dwFlags`ï¼šä¿ç•™ï¼Œå¿…é¡»ä¸º 0
* `lpMem`ï¼šè¦éªŒè¯çš„å†…å­˜åœ°å€ï¼ˆå¯ä¸º NULL è¡¨ç¤ºæ•´ä¸ªå †ï¼‰

ğŸ“„ MSDNï¼š[HeapValidate](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapvalidate)

---

## HeapWalk

æšä¸¾å †ä¸­çš„æ‰€æœ‰å†…å­˜å—ã€‚

```cpp
BOOL HeapWalk(HANDLE hHeap, LPPROCESS_HEAP_ENTRY lpEntry);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼šå †å¥æŸ„
* `lpEntry`ï¼šæŒ‡å‘ `PROCESS_HEAP_ENTRY` çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œéœ€è¦åˆå§‹åŒ– `lpData` ä¸º NULL åé¦–æ¬¡è°ƒç”¨

ğŸ“„ MSDNï¼š[HeapWalk](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapwalk)

---

## HeapDestroy

é‡Šæ”¾é€šè¿‡ `HeapCreate` åˆ›å»ºçš„å †ã€‚

```cpp
BOOL HeapDestroy(HANDLE hHeap);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hHeap`ï¼š$IN$ è¦é”€æ¯çš„å †å¥æŸ„ï¼Œå¿…é¡»æ˜¯ `HeapCreate` è¿”å›çš„ï¼Œä¸èƒ½æ˜¯é»˜è®¤å †ã€‚

**è¿”å›å€¼ï¼š** æˆåŠŸè¿”å› `TRUE`ï¼Œå¤±è´¥è¿”å› `FALSE`

ğŸ“„ MSDNï¼š[HeapDestroy](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapdestroy)



# å…³äºHeapFreeä¸HeapDestroy
æ˜¯çš„ï¼Œ`HeapFree` å’Œ `HeapDestroy` æ˜¯ä¸¤ä¸ª**ç”¨é€”å®Œå…¨ä¸åŒ**çš„å‡½æ•°ï¼š

---

### âœ… `HeapFree` â€” é‡Šæ”¾å †ä¸Šçš„å•ä¸ªå†…å­˜å—

* **ç”¨é€”ï¼š** é‡Šæ”¾ä½ ç”¨ `HeapAlloc` / `HeapReAlloc` åˆ†é…çš„æŸä¸ªç‰¹å®šå†…å­˜å—ã€‚
* **è¦æ±‚ï¼š** ä½ å¿…é¡»æä¾›åŸå§‹çš„å†…å­˜åœ°å€ï¼ˆ`lpMem`ï¼‰å’Œå¯¹åº”çš„å †å¥æŸ„ï¼ˆ`hHeap`ï¼‰ã€‚
* **è°ƒç”¨ç¤ºä¾‹ï¼š**

  ```cpp
  LPVOID p = HeapAlloc(hHeap, 0, 100);
  HeapFree(hHeap, 0, p); // é‡Šæ”¾ p æ‰€æŒ‡å‘çš„å†…å­˜
  ```
* âš ï¸ æ³¨æ„ï¼š**ä¸ä¼šé”€æ¯æ•´ä¸ªå †ï¼Œåªæ˜¯é‡Šæ”¾ä¸€ä¸ªå—ï¼**

---

### ğŸ§¨ `HeapDestroy` â€” é”€æ¯æ•´ä¸ªå †

* **ç”¨é€”ï¼š** é”€æ¯æ•´ä¸ªå †å¹¶é‡Šæ”¾å…¶ä¸­çš„æ‰€æœ‰å†…å­˜ï¼Œé€‚ç”¨äºä½ è‡ªå·±åˆ›å»ºçš„å †ï¼ˆæ¥è‡ª `HeapCreate`ï¼‰ã€‚
* **è¦æ±‚ï¼š** åªèƒ½å¯¹ `HeapCreate` åˆ›å»ºçš„å †ä½¿ç”¨ï¼Œä¸èƒ½å¯¹ `GetProcessHeap()` è¿”å›çš„é»˜è®¤å †ä½¿ç”¨ã€‚
* **è°ƒç”¨ç¤ºä¾‹ï¼š**

  ```cpp
  HANDLE hMyHeap = HeapCreate(0, 0x1000, 0);
  // ... HeapAlloc ä½¿ç”¨ ...
  HeapDestroy(hMyHeap); // é”€æ¯æ•´ä¸ªå †
  ```
* âš ï¸ ä¸€æ—¦é”€æ¯ï¼Œæ‰€æœ‰åˆ†é…åœ¨è¯¥å †ä¸Šçš„å†…å­˜éƒ½**ä¸å¯è®¿é—®**ï¼Œå¹¶è‡ªåŠ¨é‡Šæ”¾ã€‚

---

### æ€»ç»“å¯¹æ¯”ï¼š

| å‡½æ•°            | ç”¨é€”         | é€‚ç”¨äº               | æ˜¯å¦é‡Šæ”¾æ•´ä¸ªå † |
| ------------- | ---------- | ----------------- | ------- |
| `HeapFree`    | é‡Šæ”¾å•ä¸ªå†…å­˜å—    | ä»»æ„å †               | âŒ å¦     |
| `HeapDestroy` | é”€æ¯æ•´ä¸ªå †å’Œæ‰€æœ‰å†…å­˜ | `HeapCreate` åˆ›å»ºçš„å † | âœ… æ˜¯     |


