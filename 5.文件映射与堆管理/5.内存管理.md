# Windows 堆管理 API 中文文档

本文档整理了常用的 Windows 堆管理相关 API，包括函数说明、**详细的中文参数解释**、示例代码、输出说明与官方 MSDN 文档链接。

---

## 目录（按调用顺序排列，含功能说明）

1. [GetSystemInfo](#getsysteminfo) - 获取系统内存页面与CPU等信息
2. [GetProcessHeap](#getprocessheap) - 获取默认进程堆句柄
3. [HeapCreate](#heapcreate) - 创建新的私有堆
4. [HeapSetInformation](#heapsetinformation) - 设置堆兼容性或调试信息
5. [HeapLock / HeapUnlock](#heaplock--heapunlock) - 加锁/解锁堆（用于多线程）
6. [HeapAlloc](#heapalloc) - 从堆中分配内存
7. [HeapReAlloc](#heaprealloc) - 重新分配已分配内存块
8. [HeapSize](#heapsize) - 获取内存块实际大小
9. [HeapFree](#heapfree) - 释放已分配内存
10. [HeapCompact](#heapcompact) - 压缩堆并返回可用空间
11. [HeapValidate](#heapvalidate) - 验证堆的完整性是否损坏
12. [HeapWalk](#heapwalk) - 遍历堆中所有内存块
13. [HeapDestroy](#heapdestroy) - 销毁自定义堆释放资源

---

## GetSystemInfo

获取系统的相关信息，如页面大小、处理器数量等。

```cpp
void GetSystemInfo(LPSYSTEM_INFO lpSystemInfo);
```

**参数说明：**

* `lpSystemInfo`：$OUT$ 指向 `SYSTEM_INFO` 结构的指针，用于接收系统信息，包括：

  * `dwPageSize`：每页的字节数
  * `dwNumberOfProcessors`：逻辑处理器数量
  * `lpMaximumApplicationAddress`：进程可访问的最高地址

**示例：**

```cpp
SYSTEM_INFO si;
GetSystemInfo(&si);
std::cout << "页面大小: " << si.dwPageSize << std::endl;
```

📄 MSDN：[GetSystemInfo](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsysteminfo)

---

## GetProcessHeap

获取当前进程的默认堆句柄。

```cpp
HANDLE GetProcessHeap();
```

**返回值：**

* 返回默认堆的句柄，失败返回 `NULL`。

**示例：**

```cpp
HANDLE hHeap = GetProcessHeap();
if (hHeap) std::cout << "默认堆句柄: " << hHeap << std::endl;
```

📄 MSDN：[GetProcessHeap](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-getprocessheap)

---

## HeapCreate

创建一个新的堆对象。

```cpp
HANDLE HeapCreate(
  DWORD flOptions,
  SIZE_T dwInitialSize,
  SIZE_T dwMaximumSize
);
```

**参数说明：**

* `flOptions`：$IN$ 堆的行为选项，可取值：

  * `HEAP_GENERATE_EXCEPTIONS`：内存分配失败时抛出异常
  * `HEAP_NO_SERIALIZE`：禁用线程同步（需自行加锁）
  * `HEAP_CREATE_ENABLE_EXECUTE`：堆中允许执行代码
* `dwInitialSize`：$IN$ 堆的初始大小（以字节为单位）
* `dwMaximumSize`：$IN$ 堆的最大大小（为 0 表示可增长）

**返回值：** 成功返回堆句柄，失败返回 `NULL`

**示例：**

```cpp
HANDLE hHeap = HeapCreate(HEAP_CREATE_ENABLE_EXECUTE, 0x1000, 0);
```

📄 MSDN：[HeapCreate](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapcreate)

---

## HeapSetInformation

设置堆的行为信息。

```cpp
BOOL HeapSetInformation(
  HANDLE HeapHandle,
  HEAP_INFORMATION_CLASS HeapInformationClass,
  PVOID HeapInformation,
  SIZE_T HeapInformationLength
);
```

**参数说明：**

* `HeapHandle`：堆句柄（可为 NULL 表示所有堆）
* `HeapInformationClass`：指定要设置的信息类别，如 `HeapCompatibilityInformation`
* `HeapInformation`：指向包含设置信息的缓冲区
* `HeapInformationLength`：缓冲区长度（以字节为单位）

📄 MSDN：[HeapSetInformation](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapsetinformation)

---

## HeapLock / HeapUnlock

锁定或解锁堆，防止多线程冲突。

```cpp
BOOL HeapLock(HANDLE hHeap);
BOOL HeapUnlock(HANDLE hHeap);
```

**参数说明：**

* `hHeap`：堆句柄

📄 MSDN：

* [HeapLock](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heaplock)
* [HeapUnlock](https://learn.microsoft.com/en-us/windows/win32/api/heapapi-nf-heapapi-heapunlock)

---

## HeapAlloc

从堆中分配内存。

```cpp
LPVOID HeapAlloc(HANDLE hHeap, DWORD dwFlags, SIZE_T dwBytes);
```

**参数说明：**

* `hHeap`：$IN$ 堆句柄（可以是 `GetProcessHeap()`）
* `dwFlags`：$IN$ 控制分配行为，如：

  * `HEAP_ZERO_MEMORY`：将内存初始化为 0
* `dwBytes`：$IN$ 要分配的字节数

**返回值：** 返回指向分配内存的指针，失败返回 `NULL`

📄 MSDN：[HeapAlloc](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc)

---

## HeapReAlloc

重新分配指定内存块的大小。

```cpp
LPVOID HeapReAlloc(HANDLE hHeap, DWORD dwFlags, LPVOID lpMem, SIZE_T dwBytes);
```

**参数说明：**

* `hHeap`：堆句柄
* `dwFlags`：可用 `HEAP_ZERO_MEMORY` 初始化新内存部分
* `lpMem`：原内存指针
* `dwBytes`：新内存大小

📄 MSDN：[HeapReAlloc](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heaprealloc)

---

## HeapSize

返回指定内存块的大小。

```cpp
SIZE_T HeapSize(HANDLE hHeap, DWORD dwFlags, LPCVOID lpMem);
```

**参数说明：**

* `hHeap`：堆句柄
* `dwFlags`：保留，必须为 0
* `lpMem`：指向内存的指针

📄 MSDN：[HeapSize](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapsize)

---

## HeapFree

释放使用 `HeapAlloc` 分配的内存。

```cpp
BOOL HeapFree(HANDLE hHeap, DWORD dwFlags, LPVOID lpMem);
```

**参数说明：**

* `hHeap`：$IN$ 堆句柄
* `dwFlags`：保留，必须为 0
* `lpMem`：$IN$ 要释放的内存指针

📄 MSDN：[HeapFree](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapfree)

---

## HeapCompact

返回已提交的堆空间的大小。

```cpp
SIZE_T HeapCompact(HANDLE hHeap, DWORD dwFlags);
```

**参数说明：**

* `hHeap`：堆句柄
* `dwFlags`：保留，必须为 0

📄 MSDN：[HeapCompact](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapcompact)

---

## HeapValidate

验证堆是否已损坏。

```cpp
BOOL HeapValidate(HANDLE hHeap, DWORD dwFlags, LPCVOID lpMem);
```

**参数说明：**

* `hHeap`：堆句柄
* `dwFlags`：保留，必须为 0
* `lpMem`：要验证的内存地址（可为 NULL 表示整个堆）

📄 MSDN：[HeapValidate](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapvalidate)

---

## HeapWalk

枚举堆中的所有内存块。

```cpp
BOOL HeapWalk(HANDLE hHeap, LPPROCESS_HEAP_ENTRY lpEntry);
```

**参数说明：**

* `hHeap`：堆句柄
* `lpEntry`：指向 `PROCESS_HEAP_ENTRY` 的结构体指针，需要初始化 `lpData` 为 NULL 后首次调用

📄 MSDN：[HeapWalk](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapwalk)

---

## HeapDestroy

释放通过 `HeapCreate` 创建的堆。

```cpp
BOOL HeapDestroy(HANDLE hHeap);
```

**参数说明：**

* `hHeap`：$IN$ 要销毁的堆句柄，必须是 `HeapCreate` 返回的，不能是默认堆。

**返回值：** 成功返回 `TRUE`，失败返回 `FALSE`

📄 MSDN：[HeapDestroy](https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapdestroy)



# 关于HeapFree与HeapDestroy
是的，`HeapFree` 和 `HeapDestroy` 是两个**用途完全不同**的函数：

---

### ✅ `HeapFree` — 释放堆上的单个内存块

* **用途：** 释放你用 `HeapAlloc` / `HeapReAlloc` 分配的某个特定内存块。
* **要求：** 你必须提供原始的内存地址（`lpMem`）和对应的堆句柄（`hHeap`）。
* **调用示例：**

  ```cpp
  LPVOID p = HeapAlloc(hHeap, 0, 100);
  HeapFree(hHeap, 0, p); // 释放 p 所指向的内存
  ```
* ⚠️ 注意：**不会销毁整个堆，只是释放一个块！**

---

### 🧨 `HeapDestroy` — 销毁整个堆

* **用途：** 销毁整个堆并释放其中的所有内存，适用于你自己创建的堆（来自 `HeapCreate`）。
* **要求：** 只能对 `HeapCreate` 创建的堆使用，不能对 `GetProcessHeap()` 返回的默认堆使用。
* **调用示例：**

  ```cpp
  HANDLE hMyHeap = HeapCreate(0, 0x1000, 0);
  // ... HeapAlloc 使用 ...
  HeapDestroy(hMyHeap); // 销毁整个堆
  ```
* ⚠️ 一旦销毁，所有分配在该堆上的内存都**不可访问**，并自动释放。

---

### 总结对比：

| 函数            | 用途         | 适用于               | 是否释放整个堆 |
| ------------- | ---------- | ----------------- | ------- |
| `HeapFree`    | 释放单个内存块    | 任意堆               | ❌ 否     |
| `HeapDestroy` | 销毁整个堆和所有内存 | `HeapCreate` 创建的堆 | ✅ 是     |


