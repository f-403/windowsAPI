

# Windows API `CREATE_NEW_PROCESS_GROUP` ç”¨æ³•è¯´æ˜

## ğŸ“‘ ç›®å½•

1. [æ¦‚è¿°](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#%E6%A6%82%E8%BF%B0)

2. [ä½œç”¨](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#%E4%BD%9C%E7%94%A8)

3. [MSDN å‚è€ƒ](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#msdn-%E5%8F%82%E8%80%83)

4. [ç¤ºä¾‹ç¨‹åº](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F)
   
   - [å­è¿›ç¨‹ï¼šä¿¡å·å¤„ç†ç¨‹åº](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F)
   
   - [çˆ¶è¿›ç¨‹ï¼šåˆ›å»ºæ–°è¿›ç¨‹ç»„å¹¶å‘é€ä¿¡å·](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#%E7%88%B6%E8%BF%9B%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%96%B0%E8%BF%9B%E7%A8%8B%E7%BB%84%E5%B9%B6%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7)

5. [è¿è¡Œæ•ˆæœ](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C)

6. [æ³¨æ„äº‹é¡¹](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9)

7. [æ€»ç»“](https://chatgpt.com/c/68a44f83-d054-832c-8a07-dd3124965670#%E6%80%BB%E7%BB%93)

---

## æ¦‚è¿°

åœ¨ Windows API çš„ **`CreateProcess`** ä¸­ï¼Œå¯ä»¥é€šè¿‡ `dwCreationFlags` æŒ‡å®šè¿›ç¨‹åˆ›å»ºé€‰é¡¹ã€‚  
å…¶ä¸­ **`CREATE_NEW_PROCESS_GROUP`** ç”¨äºè®©æ–°è¿›ç¨‹æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ç»„æ ¹è¿›ç¨‹ã€‚

---

## ä½œç”¨

1. æ–°è¿›ç¨‹æˆä¸ºæ–°è¿›ç¨‹ç»„çš„æ ¹è¿›ç¨‹ï¼ˆç»„ ID = æ ¹è¿›ç¨‹ PIDï¼‰ã€‚

2. çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸å†å…±äº«æ§åˆ¶å°ä¿¡å·ï¼ˆå¦‚ `Ctrl+C`ï¼‰ã€‚

3. çˆ¶è¿›ç¨‹å¯ä»¥é€šè¿‡ `GenerateConsoleCtrlEvent` å•ç‹¬å‘è¯¥è¿›ç¨‹ç»„å‘é€æ§åˆ¶å°äº‹ä»¶ã€‚

---

## MSDN å‚è€ƒ

- [Process Creation Flags - CREATE_NEW_PROCESS_GROUP](https://learn.microsoft.com/en-us/windows/win32/procthread/process-creation-flags#CREATE_NEW_PROCESS_GROUP)

---

## ç¤ºä¾‹ç¨‹åº

### å­è¿›ç¨‹ï¼šä¿¡å·å¤„ç†ç¨‹åº

ç¼–è¯‘æˆ `child.exe`ï¼Œç”¨äºæµ‹è¯•ä¿¡å·æ•è·ï¼š

```cpp
// child.cpp
#include <windows.h>
#include <iostream>

BOOL WINAPI ConsoleHandler(DWORD signal) {
    switch (signal) {
    case CTRL_C_EVENT:
        std::cout << "[å­è¿›ç¨‹] æ”¶åˆ° CTRL+C ä¿¡å·" << std::endl;
        return TRUE;  // é˜»æ­¢é»˜è®¤é€€å‡ºè¡Œä¸º
    case CTRL_BREAK_EVENT:
        std::cout << "[å­è¿›ç¨‹] æ”¶åˆ° CTRL+BREAK ä¿¡å·" << std::endl;
        return TRUE;
    default:
        return FALSE;
    }
}

int main() {
    SetConsoleCtrlHandler(ConsoleHandler, TRUE);

    std::cout << "[å­è¿›ç¨‹] å·²å¯åŠ¨ï¼ŒPID=" << GetCurrentProcessId()
              << "ï¼Œç­‰å¾…æ§åˆ¶å°ä¿¡å·..." << std::endl;

    while (true) {
        Sleep(1000);
    }
    return 0;
}
```

---

### çˆ¶è¿›ç¨‹ï¼šåˆ›å»ºæ–°è¿›ç¨‹ç»„å¹¶å‘é€ä¿¡å·

çˆ¶è¿›ç¨‹åˆ›å»º `child.exe`ï¼ŒæŒ‡å®š `CREATE_NEW_PROCESS_GROUP`ï¼Œç„¶åå‘é€ `CTRL_BREAK_EVENT`ï¼š

```cpp
// parent.cpp
#include <windows.h>
#include <iostream>

int main() {
    STARTUPINFO si = { sizeof(si) };
    PROCESS_INFORMATION pi;

    BOOL ok = CreateProcess(
        L"child.exe",   // è‡ªå®šä¹‰å­è¿›ç¨‹
        NULL,
        NULL, NULL,
        TRUE,  // ç»§æ‰¿æ§åˆ¶å°ï¼Œä¿è¯ä¿¡å·å¯è·¯ç”±
        CREATE_NEW_PROCESS_GROUP, // å…³é”®æ ‡å¿—
        NULL, NULL,
        &si, &pi);

    if (!ok) {
        std::cout << "CreateProcess failed: " << GetLastError() << std::endl;
        return 1;
    }

    std::cout << "[çˆ¶è¿›ç¨‹] å­è¿›ç¨‹ PID=" << pi.dwProcessId
              << " å·²å¯åŠ¨ï¼ˆç‹¬ç«‹è¿›ç¨‹ç»„ï¼‰" << std::endl;

    Sleep(3000);

    std::cout << "[çˆ¶è¿›ç¨‹] å‘é€ CTRL_BREAK_EVENT ç»™å­è¿›ç¨‹ç»„..." << std::endl;
    GenerateConsoleCtrlEvent(CTRL_BREAK_EVENT, pi.dwProcessId);

    Sleep(3000);

    std::cout << "[çˆ¶è¿›ç¨‹] ç­‰å¾…å­è¿›ç¨‹é€€å‡º (Ctrl+Break è¢«æ‹¦æˆªåä»åœ¨è¿è¡Œ)" << std::endl;

    // å¦‚æœæƒ³ç»ˆæ­¢å­è¿›ç¨‹ï¼Œå¯ä»¥æ‰‹åŠ¨ç»“æŸ
    TerminateProcess(pi.hProcess, 0);

    CloseHandle(pi.hProcess);
    CloseHandle(pi.hThread);
    return 0;
}
```

---

## è¿è¡Œæ•ˆæœ

1. è¿è¡Œçˆ¶è¿›ç¨‹ â†’ åˆ›å»º `child.exe`ï¼Œä½œä¸ºç‹¬ç«‹è¿›ç¨‹ç»„ã€‚

2. å­è¿›ç¨‹æ‰“å°ï¼š
   
   ```
   [å­è¿›ç¨‹] å·²å¯åŠ¨ï¼ŒPID=1234ï¼Œç­‰å¾…æ§åˆ¶å°ä¿¡å·...
   ```

3. çˆ¶è¿›ç¨‹è°ƒç”¨ `GenerateConsoleCtrlEvent(CTRL_BREAK_EVENT, å­è¿›ç¨‹PID)`ã€‚

4. å­è¿›ç¨‹æ•è·å¹¶è¾“å‡ºï¼š
   
   ```
   [å­è¿›ç¨‹] æ”¶åˆ° CTRL+BREAK ä¿¡å·
   ```

5. çˆ¶è¿›ç¨‹ä¸ä¼šé€€å‡ºï¼Œä¹Ÿä¸ä¼šæ”¶åˆ°ä¿¡å·ã€‚

---

## æ³¨æ„äº‹é¡¹

- `GenerateConsoleCtrlEvent` å¿…é¡»åœ¨åŒä¸€æ§åˆ¶å°å†…ä½¿ç”¨ã€‚

- `CTRL_C_EVENT` åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½è¢«å¿½ç•¥ï¼Œæ¨èç”¨ `CTRL_BREAK_EVENT` æµ‹è¯•ã€‚

- GUI ç¨‹åºä¸ä¼šå“åº”æ§åˆ¶å°ä¿¡å·ã€‚

- å­è¿›ç¨‹å¿…é¡»æ˜¯ **æ§åˆ¶å°å­ç³»ç»Ÿ (Console Subsystem)** ç¨‹åºï¼Œå¦åˆ™ä¿¡å·ä¸ä¼šä¼ é€’ã€‚

---

## æ€»ç»“

- `CREATE_NEW_PROCESS_GROUP` è®©å­è¿›ç¨‹ç‹¬ç«‹äºçˆ¶è¿›ç¨‹çš„æ§åˆ¶å°ä¿¡å·ç®¡ç†ã€‚

- çˆ¶è¿›ç¨‹å¯ç”¨ `GenerateConsoleCtrlEvent` å•ç‹¬æ§åˆ¶å­è¿›ç¨‹ç»„ã€‚

- é…åˆ `SetConsoleCtrlHandler` å¯ä»¥éªŒè¯ä¿¡å·ä¼ æ’­æœºåˆ¶ã€‚

---


