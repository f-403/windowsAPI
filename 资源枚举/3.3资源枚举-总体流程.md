# Windows èµ„æºæšä¸¾ä¸ä½¿ç”¨å®Œæ•´æŒ‡å—ï¼ˆé€‚åˆåˆå­¦è€…ï¼‰

> åŒ…å«äº’æ–¥ä½“ä½¿ç”¨ã€DLL å»¶è¿Ÿå¯¼å…¥ã€èµ„æºæŸ¥æ‰¾ä¸æšä¸¾ã€å­—ç¬¦ä¸²è½¬æ¢ç­‰å†…å®¹

---

## ğŸ“š ç›®å½•

1. [åˆ›å»ºäº’æ–¥ä½“](#1-åˆ›å»ºäº’æ–¥ä½“)
2. [å»¶è¿ŸåŠ è½½ DLL çš„å¯¼å‡ºå‡½æ•°](#2-å»¶è¿ŸåŠ è½½-dll-çš„å¯¼å‡ºå‡½æ•°)
3. [æŸ¥æ‰¾å¹¶åŠ è½½èµ„æº](#3-æŸ¥æ‰¾å¹¶åŠ è½½èµ„æº)
4. [æšä¸¾ DLL ä¸­çš„èµ„æº](#4-æšä¸¾-dll-ä¸­çš„èµ„æº)

   * [4.1 LoadLibraryExW åŠ è½½ DLL](#41-loadlibraryexw-åŠ è½½-dll)
   * [4.2 EnumResourceTypesW æšä¸¾èµ„æºç±»å‹](#42-enumresourcetypesw-æšä¸¾èµ„æºç±»å‹)
   * [4.3 EnumResourceNamesW æšä¸¾èµ„æºåç§°](#43-enumresourcenamesw-æšä¸¾èµ„æºåç§°)
   * [4.4 EnumResourceLanguagesW æšä¸¾è¯­è¨€ ID](#44-enumresourcelanguagesw-æšä¸¾è¯­è¨€-id)
5. [è‡ªå®šä¹‰å›è°ƒå‡½æ•°ç¤ºä¾‹](#5-è‡ªå®šä¹‰å›è°ƒå‡½æ•°ç¤ºä¾‹)
6. [èµ„æºæšä¸¾è°ƒç”¨æµç¨‹](#6-èµ„æºæšä¸¾è°ƒç”¨æµç¨‹)
7. [åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬ ASCIIï¼ˆstrtol ç”¨æ³•ï¼‰](#7-åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬-asciistrtol-ç”¨æ³•)
8. [å‡½æ•°è°ƒç”¨é¡ºåºæ€»ç»“](#8-å‡½æ•°è°ƒç”¨é¡ºåºæ€»ç»“)

---

## 1. åˆ›å»ºäº’æ–¥ä½“

```cpp
HANDLE first = CreateMutex(NULL, FALSE, L"WeChat");
if (GetLastError() == ERROR_ALREADY_EXISTS) {
    // ç¨‹åºå·²åœ¨è¿è¡Œ
}
CloseHandle(first); // é‡Šæ”¾å¥æŸ„
```

**å‚æ•°è¯´æ˜ï¼š**

* `lpMutexAttributes`ï¼šå®‰å…¨å±æ€§ï¼Œé€šå¸¸è®¾ä¸º `NULL`
* `bInitialOwner`ï¼šæ˜¯å¦ç”±å½“å‰çº¿ç¨‹ç«‹å³æ‹¥æœ‰äº’æ–¥ä½“ï¼Œ`FALSE` è¡¨ç¤ºå¦
* `lpName`ï¼šå‘½åäº’æ–¥ä½“åç§°ï¼Œç”¨äºå¤šè¿›ç¨‹åŒæ­¥

ğŸ“– [CreateMutex MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/synchapi/nf-synchapi-createmutexw)

---

## 2. å»¶è¿ŸåŠ è½½ DLL çš„å¯¼å‡ºå‡½æ•°

```cpp
extern "C" __declspec(dllexport) void dll_test();
```

> å»¶è¿Ÿå¯¼å…¥é€šè¿‡é“¾æ¥å™¨è®¾ç½®å»¶ååŠ è½½ï¼Œä¸éœ€è¦æ˜¾å¼è°ƒç”¨ `LoadLibrary`ã€‚

---

## 3. æŸ¥æ‰¾å¹¶åŠ è½½èµ„æº

```cpp
HRSRC hrsrc = FindResource(NULL, MAKEINTRESOURCE(IDR_MYTEST), L"MYTEST");
DWORD size = SizeofResource(NULL, hrsrc);
HANDLE hResData = LoadResource(NULL, hrsrc);
LPVOID pData = LockResource(hResData);
```

**å‡½æ•°å‚æ•°è¯´æ˜ï¼š**

* `FindResource`ï¼š

  * `hModule`ï¼šæ¨¡å—å¥æŸ„ï¼Œå½“å‰è¿›ç¨‹å¯ä¸º `NULL`
  * `lpName`ï¼šèµ„æºåç§°ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ– `MAKEINTRESOURCE(ID)`
  * `lpType`ï¼šèµ„æºç±»å‹ï¼Œå¦‚ `RT_RCDATA`

* `SizeofResource`ï¼šè¿”å›èµ„æºå¤§å°ï¼ˆå­—èŠ‚ï¼‰

* `LoadResource`ï¼šè¿”å›èµ„æºå¥æŸ„ï¼Œéœ€ä¼ å…¥æ¨¡å—å¥æŸ„ä¸èµ„æºå¥æŸ„

* `LockResource`ï¼šå°†èµ„æºé”å®šåˆ°å†…å­˜ï¼Œè¿”å› `LPVOID` æŒ‡é’ˆ

ğŸ“– [FindResource MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/libloaderapi/nf-libloaderapi-findresourcew)

---

## 4. æšä¸¾ DLL ä¸­çš„èµ„æº

### 4.1 LoadLibraryExW åŠ è½½ DLL

```cpp
HMODULE dll = LoadLibraryExW(L"my.dll", NULL,
    LOAD_LIBRARY_AS_DATAFILE | LOAD_LIBRARY_AS_IMAGE_RESOURCE);
```

**å‚æ•°è¯´æ˜ï¼š**

* `lpLibFileName`ï¼šDLL æ–‡ä»¶è·¯å¾„
* `hFile`ï¼šä¿ç•™å‚æ•°ï¼Œå¿…é¡»ä¸º NULL
* `dwFlags`ï¼šåŠ è½½æ ‡å¿—ï¼Œå¦‚ï¼š

  * `LOAD_LIBRARY_AS_DATAFILE`
  * `LOAD_LIBRARY_AS_IMAGE_RESOURCE`

ğŸ“– [LoadLibraryExW MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryexw)

---

### 4.2 EnumResourceTypesW æšä¸¾èµ„æºç±»å‹

```cpp
EnumResourceTypesW(dll, EnumResTypeProc, 0);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hModule`ï¼šDLL/EXE æ¨¡å—å¥æŸ„
* `lpEnumFunc`ï¼šå›è°ƒå‡½æ•°æŒ‡é’ˆ
* `lParam`ï¼šç”¨æˆ·è‡ªå®šä¹‰å‚æ•°ï¼Œä¼ é€’ç»™å›è°ƒå‡½æ•°

ğŸ“– [EnumResourceTypesW MSDN](https://learn.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-enumresourcetypesw)

---

### 4.3 EnumResourceNamesW æšä¸¾èµ„æºåç§°

```cpp
EnumResourceNamesW(hModule, lpType, EnumResNameProc, lParam);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hModule`ï¼šæ¨¡å—å¥æŸ„
* `lpType`ï¼šèµ„æºç±»å‹ï¼Œå¯ä¸ºå­—ç¬¦ä¸²æˆ– `MAKEINTRESOURCE(ID)`
* `lpEnumFunc`ï¼šæšä¸¾åç§°çš„å›è°ƒå‡½æ•°
* `lParam`ï¼šç”¨æˆ·å‚æ•°ï¼Œä¼ é€’ç»™å›è°ƒ

ğŸ“– [EnumResourceNamesW MSDN](https://learn.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-enumresourcenamesw)

---

### 4.4 EnumResourceLanguagesW æšä¸¾è¯­è¨€ ID

```cpp
EnumResourceLanguagesW(hModule, lpType, lpName, EnumResLangProc, lParam);
```

**å‚æ•°è¯´æ˜ï¼š**

* `hModule`ï¼šæ¨¡å—å¥æŸ„
* `lpType`ï¼šèµ„æºç±»å‹
* `lpName`ï¼šèµ„æºåç§°
* `lpEnumFunc`ï¼šå›è°ƒå‡½æ•°
* `lParam`ï¼šè‡ªå®šä¹‰å‚æ•°

ğŸ“– [EnumResourceLanguagesW MSDN](https://learn.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-enumresourcelanguagesw)

---

## 5. è‡ªå®šä¹‰å›è°ƒå‡½æ•°ç¤ºä¾‹

### 5.1 èµ„æºç±»å‹æšä¸¾å›è°ƒ

```cpp
BOOL CALLBACK EnumResTypeProc(HMODULE hModule, LPCWSTR lpType, LONG_PTR lParam) {
    if (IS_INTRESOURCE(lpType))
        wprintf(L"èµ„æºç±»å‹ID: %d\n", (int)lpType);
    else
        wprintf(L"èµ„æºç±»å‹å: %s\n", lpType);

    EnumResourceNamesW(hModule, lpType, EnumResNameProc, lParam);
    return TRUE;
}
```

### 5.2 èµ„æºåç§°æšä¸¾å›è°ƒ

```cpp
BOOL CALLBACK EnumResNameProc(HMODULE hModule, LPCWSTR lpType, LPCWSTR lpName, LONG_PTR lParam) {
    if (IS_INTRESOURCE(lpName))
        wprintf(L"  èµ„æºID: %d\n", (int)lpName);
    else
        wprintf(L"  èµ„æºåç§°: %s\n", lpName);

    EnumResourceLanguagesW(hModule, lpType, lpName, EnumResLangProc, lParam);
    return TRUE;
}
```

### 5.3 èµ„æºè¯­è¨€ ID æšä¸¾å›è°ƒ

```cpp
BOOL CALLBACK EnumResLangProc(HMODULE hModule, LPCWSTR lpType, LPCWSTR lpName, WORD wLang, LONG_PTR lParam) {
    wprintf(L"      è¯­è¨€ID: 0x%04X\n", wLang);
    return TRUE;
}
```

---

## 6. èµ„æºæšä¸¾è°ƒç”¨æµç¨‹

```cpp
HMODULE hModule = LoadLibraryExW(L"test.dll", NULL, 
    LOAD_LIBRARY_AS_DATAFILE | LOAD_LIBRARY_AS_IMAGE_RESOURCE);

if (hModule) {
    EnumResourceTypesW(hModule, EnumResTypeProc, 0);
    FreeLibrary(hModule);
}
```

ğŸ“Œ è°ƒç”¨å…³ç³»ï¼š

```
EnumResourceTypesW â†’ EnumResTypeProc â†’ EnumResourceNamesW â†’ EnumResNameProc â†’ EnumResourceLanguagesW â†’ EnumResLangProc
```

---

## 7. åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬ ASCIIï¼ˆstrtol ç”¨æ³•ï¼‰

```cpp
std::string text;
const char* data = "7368656c6c636f646520696e2068657265";
for (int i = 0; i < strlen(data); i += 2) {
    char temp[3] = { data[i], data[i + 1], 0 };
    text += char(strtol(temp, nullptr, 16));
}
```

è¾“å‡ºï¼š

```
shellcode in here
```

ğŸ“– [strtol MSDN æ–‡æ¡£](https://learn.microsoft.com/zh-cn/cpp/c-runtime-library/reference/strtol-strtoll-strtod-strtold?view=msvc-170)

---

## 8. å‡½æ•°è°ƒç”¨é¡ºåºæ€»ç»“

1. ä½¿ç”¨ `LoadLibraryExW` åŠ è½½ DLL æˆ– EXEã€‚
2. è°ƒç”¨ `EnumResourceTypesW` â†’ å›è°ƒ `EnumResTypeProc`
3. åœ¨ç±»å‹å›è°ƒä¸­è°ƒç”¨ `EnumResourceNamesW` â†’ å›è°ƒ `EnumResNameProc`
4. åœ¨åç§°å›è°ƒä¸­è°ƒç”¨ `EnumResourceLanguagesW` â†’ å›è°ƒ `EnumResLangProc`
5. åœ¨ä»»ä½•å›è°ƒä¸­è¿”å› `FALSE` å¯ç»ˆæ­¢å½“å‰å±‚çº§çš„æšä¸¾ã€‚

ä»¥ä¸Šå°±æ˜¯å®Œæ•´çš„ DLL èµ„æºåŠ è½½ä¸æšä¸¾æ–¹æ³•ï¼Œé€‚åˆç”¨äºåˆ†æèµ„æºã€è‡ªå®šä¹‰åŠ è½½ã€å£³èµ„æºæå–ç­‰ç”¨é€”ã€‚
